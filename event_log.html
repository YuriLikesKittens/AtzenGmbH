<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Event-Log · Einträge & Proof-Links</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1020; --bg2:#0f172a;
      --text:#e5e7eb; --muted:#9aa4b2;
      --border:rgba(255,255,255,.14);
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --radius:18px; --radius-sm:12px;
      --shadow:0 18px 42px rgba(0,0,0,.45);
      --accent:#7c3aed; --accent2:#06b6d4; --green:#22c55e; --red:#ef4444;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    html{ overflow-y:auto; scrollbar-gutter: stable; }
    body{
      min-height:100svh; margin:0;color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 8% 10%, rgba(124,58,237,.12), transparent 40%),
        radial-gradient(1000px 700px at 85% 15%, rgba(6,182,212,.12), transparent 45%),
        linear-gradient(160deg,var(--bg) 0%, var(--bg2) 100%);
      padding:28px 16px 40px; overflow-x:hidden;
    }

    .net-bg{position:fixed; inset:0; pointer-events:none; z-index:0}
    .net-bg canvas{width:100%; height:100%; display:block}

    .wrap{max-width:1150px;margin:0 auto;position:relative;z-index:1}

    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    h1{margin:0;font-family:Orbitron, Inter;font-size:clamp(22px,4vw,34px);letter-spacing:.02em}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    a.btn, button.btn{
      appearance:none;border:0;cursor:pointer;
      padding:10px 14px;border-radius:12px;font-weight:800;color:#fff;text-decoration:none;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 10px 26px rgba(6,182,212,.34), inset 0 0 0 1px rgba(255,255,255,.06);
      transition:.2s transform, .2s filter, .2s box-shadow;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.05);box-shadow:0 14px 34px rgba(124,58,237,.30)}

    /* Nur hier angepasst: eine Spalte, da die Hinweise-Box entfernt wurde */
    .row-hero{ display:grid; gap:10px; grid-template-columns: 1fr; align-items:start; margin-bottom:10px; }
    @media (max-width:980px){ .row-hero{ grid-template-columns:1fr; } }
    .row-list{ display:block; }

    .card{
      border-radius:var(--radius);
      background:
        radial-gradient(120% 150% at 0% 0%, rgba(255,255,255,.07), rgba(255,255,255,.03)),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      backdrop-filter:saturate(1.2) blur(8px);
      padding:18px;
    }
    .card h2{margin:0 0 12px;font-size:18px}

    label{font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)}
    input,select{
      width:100%;padding:12px 14px;border-radius:12px;
      border:1px solid var(--border);background:#0b1020;color:var(--text);
      outline:none;transition:border-color .2s, box-shadow .2s, transform .1s;
    }
    input:focus,select:focus{border-color:#4c1d95;box-shadow:0 0 0 4px rgba(124,58,237,.22)}
    .btn.primary{width:100%;margin-top:10px}

    .muted{color:var(--muted);font-size:12px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
    .chip{background:#0b1020;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#a5b4fc}
    .linkbtn{display:inline-block;margin-top:6px;border:1px solid var(--border);border-radius:10px;padding:6px 10px;text-decoration:none;color:#e5e7eb}
    .linkbtn:hover{background:#111827}

    .sticky{position:sticky; top:12px}

    .listwrap{
      border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:68vh;
      background:linear-gradient(180deg,rgba(255,255,255,.035),rgba(255,255,255,.02));
      scrollbar-gutter: stable;
    }
    .listhead{
      position:sticky;top:0;z-index:1;display:flex;justify-content:space-between;align-items:center;
      padding:12px;border-bottom:1px solid var(--border);background:#0a0f1f;border-top-left-radius:12px;border-top-right-radius:12px;
    }
    .badge{padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:#cbd5e1;font-size:12px}
    .list{display:grid;gap:12px;padding:12px}

    .item{
      position:relative;display:grid;grid-template-columns:160px 1fr;gap:14px;
      border:1px solid var(--border);border-radius:14px;padding:12px;
      background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
      transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
      will-change: transform;
    }
    .item:hover{transform:translateY(-1px);border-color:rgba(124,58,237,.35);box-shadow:0 8px 18px rgba(0,0,0,.35)}
    @media (max-width:640px){.item{grid-template-columns:1fr}}
    .thumb{width:100%;height:120px;max-width:160px;background:#0a0f1f;border:1px solid var(--border);border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;filter:contrast(1.05)}
    .content{min-width:0}
    .title{margin:0 0 6px;font-weight:800}
    .evName{font-weight:800;color:var(--green)}
    .meta{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .count{color:var(--red);font-weight:800}
    .hint{font-size:12px;color:#a7b0bf;margin-top:6px}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#cbd5e1;margin-top:6px; text-decoration:none}
    .pill:hover{background:#111827}

    .admin-only{display:none}
    body.admin .admin-only{display:block}

    .delbtn, .donebtn{
      position:absolute; top:10px; width:34px; height:34px; border-radius:999px;
      cursor:pointer; display:flex; align-items:center; justify-content:center;
      font-size:16px; font-weight:800; border:1px solid var(--border);
      background:#0b1020;
    }
    .delbtn{ right:10px; color:#fca5a5; }
    .delbtn:hover{background:#1f2937;color:#fff}

    .donebtn{ right:52px; color:#bbf7d0; }
    .donebtn:hover{ background:#10251a; color:#22c55e; border-color:#14532d; }

    /* Badge für „Von Leadership bearbeitet“ */
    .review-badge{
      display:inline-flex; align-items:center; gap:6px;
      margin-top:8px; padding:6px 10px; border-radius:999px;
      background:rgba(34,197,94,.12); color:#86efac; font-weight:800;
      border:1px solid rgba(34,197,94,.35);
    }

    .listwrap::-webkit-scrollbar{width:10px}
    .listwrap::-webkit-scrollbar-track{background:transparent}
    .listwrap::-webkit-scrollbar-thumb{
      background:linear-gradient(180deg, var(--accent), var(--accent2));
      border-radius:999px;border:2px solid rgba(0,0,0,.2)
    }
    .listwrap{scrollbar-color:#7c3aed transparent;scrollbar-width:thin}

    /* Popup */
    #adminPopup{display:none; position:fixed; inset:0; z-index:999; background:rgba(0,0,0,.6); backdrop-filter:blur(4px); align-items:center; justify-content:center;}
    .adminPopup-card{width:90%; max-width:420px; border-radius:16px; background:#111827; border:1px solid var(--border); box-shadow:0 18px 42px rgba(0,0,0,.5); padding:22px;}
    .authrow{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width:640px){.authrow{grid-template-columns:1fr}}

    /* Footer RGB */
    footer{margin-top:24px;text-align:center;font-size:13px;padding:10px;font-weight:600;
      background: linear-gradient(90deg, rgb(255,0,0), rgb(0,255,0), rgb(0,0,255));
      -webkit-background-clip: text;-webkit-text-fill-color: transparent;background-clip: text;color: transparent;
      animation: rgbMove 6s linear infinite;background-size: 300% 100%;}
    @keyframes rgbMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    /* ========= Teilnehmer Chip-Input ========= */
    .chip-input{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      padding:8px; border:1px solid var(--border); border-radius:12px; background:#0b1020;
      min-height:46px;
    }
    .chip-input:focus-within{ border-color:#4c1d95; box-shadow:0 0 0 4px rgba(124,58,237,.22); }
    .chip-input .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; border:1px solid rgba(124,58,237,.5);
      background:linear-gradient(135deg, rgba(124,58,237,.18), rgba(6,182,212,.16));
      color:#e9e7ff; font-weight:700; letter-spacing:.01em;
    }
    .chip-input .chip .chipx{
      appearance:none; border:0; background:#0b1020; color:#fff; opacity:.8;
      width:20px; height:20px; border-radius:999px; cursor:pointer; line-height:20px; text-align:center;
      font-weight:900; padding:0;
    }
    .chip-input .chip .chipx:hover{ opacity:1; background:#1f2937; }
    .chip-input input{
      flex:1 0 180px; min-width:160px; border:0; outline:0; background:transparent; color:var(--text); padding:8px 6px;
    }
    .helper{ margin-top:6px; color:#9aa4b2; font-size:12px; }
    .helper .kbd{
      display:inline-block; padding:2px 6px; border:1px solid var(--border); border-bottom-width:2px; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Collapsible Teilnehmerliste */
    details.participants{ margin-top:8px; border:1px solid var(--border); border-radius:10px; }
    details.participants summary{
      cursor:pointer; padding:8px 10px; user-select:none;
      background:rgba(255,255,255,.03); border-radius:10px;
      font-weight:700; color:#c7d2fe; outline:none;
    }
    details.participants[open] summary{ border-bottom:1px solid var(--border); border-bottom-left-radius:0;border-bottom-right-radius:0; }
    .plist{ padding:10px; display:grid; gap:6px; font-size:13px; }
    .plist .pitem{ display:flex; justify-content:space-between; gap:10px; border:1px solid var(--border); border-radius:10px; padding:6px 10px; background:#0b1020; }
    .plist .pname{ font-weight:700; color:#e5e7eb; }
    .plist .pid{ color:#93c5fd; font-family:ui-monospace, monospace; }
  </style>
</head>
<body>
  <!-- Partikel-Hintergrund -->
  <div class="net-bg" aria-hidden="true"><canvas id="netCanvas"></canvas></div>

  <div class="wrap">
    <div class="topbar">
      <h1>Event-Log · Einträge & Proof-Links</h1>
      <div class="actions">
        <a class="btn" href="index.html">Zur Übersicht</a>
        <button class="btn" id="btnAdminLogin">Admin-Login</button>
      </div>
    </div>

    <!-- Popup-Login -->
    <div id="adminPopup">
      <div class="adminPopup-card">
        <h2 style="margin:0 0 14px;font-size:18px">Admin Login</h2>
        <div class="authrow" style="margin-bottom:12px">
          <div>
            <label>E-Mail</label>
            <input type="email" id="email" placeholder="admin@beispiel.de" />
          </div>
          <div>
            <label>Passwort</label>
            <input type="password" id="password" placeholder="********" />
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnLogin">Anmelden</button>
          <button class="btn" id="btnLogout" style="display:none">Abmelden</button>
          <button class="btn" id="btnClosePopup" style="background:#6b7280">Schließen</button>
        </div>
        <p class="muted" id="authState" style="margin-top:8px"></p>
      </div>
    </div>

    <!-- OBERER BEREICH: EIN SPALTE (Hinweise-Box entfernt) -->
    <div class="row-hero">
      <!-- Linke Spalte (sticky) -->
      <div class="card sticky">
        <h2>Neues Event eintragen</h2>
        <div class="chips">
          <span class="chip">Letzte Auswahl bleibt leer</span>
          <span class="chip">Proof optional</span>
        </div>

        <!-- 1) Eventtyp + Mitglieder (Mitglieder = readonly, auto) -->
        <div style="display:grid;gap:12px;grid-template-columns:1fr;margin-top:8px">
          <div>
            <label>Art des Events</label>
            <select id="eventType"><option value="">— Bitte wählen —</option></select>
          </div>
          <div>
            <label>Mitglieder [Müssen nicht mehr Eingtragen werden]</label>
            <input type="number" id="memberCount" min="0" step="1" placeholder="0" readonly />
          </div>
        </div>

        <!-- 2) Teilnehmer und 3) Proof jeweils untereinander -->
        <div style="display:grid;gap:12px;grid-template-columns:1fr">
          <div>
            <label>Teilnehmer</label>
            <div id="participantsInput" class="chip-input" role="group" aria-label="Teilnehmer">
              <!-- Chips kommen hier dynamisch rein -->
              <input id="participantText" type="text" placeholder="Name#ID eingeben und Enter drücken!" />
            </div>
            <div class="helper">
              Format: <b>Name#ID</b>, dann <span class="kbd">Enter</span> / <span class="kbd">,</span> / <span class="kbd">;</span> / <span class="kbd">Tab</span>. &nbsp;Beispiel: <i>Max#4711</i>
            </div>
          </div>

          <div>
            <label>Proof-URL Pflicht</label>
            <input type="url" id="proofUrl" placeholder="Hier fügst du den Imgur Link ein" />
            <a class="linkbtn" href="https://imgur.com/upload" target="_blank" rel="noopener">Bild bei Imgur hochladen ↗</a>
            <div class="muted">Bild hochladen und dann einfügen!.</div>
          </div>
        </div>

        <!-- 4) Bemerkung -->
        <div style="display:grid;gap:12px;grid-template-columns:1fr">
          <div>
            <label>Bemerkung (optional)</label>
            <input type="text" id="note" placeholder="Anmerkungen" />
          </div>
        </div>

        <button class="btn primary" id="btnSubmit">Eintragen</button>
        <p class="muted" id="status"></p>
      </div>
    </div>

    <!-- UNTERER BEREICH: volle Breite, eigene Section -->
    <div class="row-list">
      <div class="card">
        <h2 style="margin-bottom:10px">Letzte Events</h2>
        <div class="listwrap">
          <div class="listhead">
            <span class="muted">Neueste zuerst</span>
            <span class="badge" id="counter">0 Einträge</span>
          </div>
          <div id="list" class="list"></div>
        </div>
      </div>
    </div>
  </div>

  <footer>Made by Alvaro SolanoHebel | 20367</footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBgPA5LV1ILz5MmyzUezVumMgOuWoxfNxo",
      authDomain: "msauszahlung.firebaseapp.com",
      projectId: "msauszahlung",
      storageBucket: "msauszahlung.appspot.com",
      messagingSenderId: "1033439801595",
      appId: "1:1033439801595:web:4251badc1447ed8079805e",
      measurementId: "G-FWXF3GM505"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(e){ if(!/already exists/i.test(String(e))) throw e; }
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const eventOptions = [
      "40er","50er","Bank","Bizwar","Cayo","EKZ/Mall","Gießerei","Hafen Drop",
      "RP Fabrik","Waffenfabrik","Drogenlabor Angriff","Flugzeugträger",
      "Raid / Angriff","Raid / Verteidigung","Famwar", "Shop / Ammu Raub", "Zinken",
    ];

    const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1411850377560592527/2V4Xmj0iJeLIsDUVkz9ow9KEFdvhU9cffPcQqZtJUfOmkFoBzj5kBAaYSn9zXhO17ocJ";

    const btnAdminLogin = document.getElementById('btnAdminLogin');
    const adminPopup    = document.getElementById('adminPopup');
    const btnClosePopup = document.getElementById('btnClosePopup');
    const email         = document.getElementById('email');
    const password      = document.getElementById('password');
    const btnLogin      = document.getElementById('btnLogin');
    const btnLogout     = document.getElementById('btnLogout');
    const authState     = document.getElementById('authState');

    btnAdminLogin.addEventListener('click', ()=>{ adminPopup.style.display = 'flex'; });
    btnClosePopup.addEventListener('click', ()=>{ adminPopup.style.display = 'none'; });
    adminPopup.addEventListener('click', (e)=>{ if(e.target === adminPopup) adminPopup.style.display='none'; });

    function setAdminUI(on){
      document.body.classList.toggle('admin', !!on);
      btnLogin.style.display  = on ? 'none' : 'inline-block';
      btnLogout.style.display = on ? 'inline-block' : 'none';
      authState.textContent   = on ? 'Angemeldet' : 'Abgemeldet';
    }
    btnLogin.addEventListener('click', async () => {
      authState.textContent = 'Anmeldung läuft…';
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
        await auth.signInWithEmailAndPassword(email.value, password.value);
        setAdminUI(true);
      }catch(e){ authState.textContent = e?.message || 'Login fehlgeschlagen'; }
    });
    btnLogout.addEventListener('click', async () => { await auth.signOut(); });
    auth.onAuthStateChanged(user => setAdminUI(!!user));

    const eventType     = document.getElementById('eventType');
    const memberCount   = document.getElementById('memberCount');
    const proofUrlInput = document.getElementById('proofUrl');
    const note          = document.getElementById('note');
    const btnSubmit     = document.getElementById('btnSubmit');
    const statusEl      = document.getElementById('status');
    const listEl        = document.getElementById('list');
    const counterEl     = document.getElementById('counter');

    // === Teilnehmer Chip-Input ===
    const participantsInput = document.getElementById('participantsInput');
    const participantText   = document.getElementById('participantText');
    let participantsArr     = []; // [{name, id}]

    function populateEventSelect(){
      eventType.innerHTML = '<option value="">— Bitte wählen —</option>';
      for(const label of eventOptions){
        const opt=document.createElement('option'); opt.value=label; opt.textContent=label;
        eventType.appendChild(opt);
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      populateEventSelect();
      updateMemberCountInput(); // initial anzeigen (0)
    });

    // Parse "Name#ID" -> {name,id}
    function parseParticipant(input){
      if(!input) return null;
      const raw = String(input).trim().replace(/\s+/g,' ');
      const m = raw.match(/^(.+?)\s*#\s*([A-Za-z0-9_-]{1,32})$/);
      if(!m) return null;
      const name = m[1].trim();
      const id   = m[2].trim();
      if(!name || !id) return null;
      return {name, id};
    }

    function participantKey(p){ return (p.name + '|' + p.id).toLowerCase(); }

    function addParticipantFromText(){
      const p = parseParticipant(participantText.value);
      if(!p){
        participantText.style.transform='scale(0.99)';
        participantText.style.boxShadow='0 0 0 4px rgba(239,68,68,.22)';
        setTimeout(()=>{ participantText.style.transform=''; participantText.style.boxShadow=''; },160);
        return;
      }
      if (participantsArr.some(x => participantKey(x) === participantKey(p))) {
        participantText.value = '';
        return;
      }
      participantsArr.push(p);
      participantText.value = '';
      renderParticipantsChips();
    }

    function removeParticipantByKey(key){
      participantsArr = participantsArr.filter(p => participantKey(p) !== key);
      renderParticipantsChips();
    }

    function updateMemberCountInput(){
      if(memberCount) memberCount.value = String(participantsArr.length);
    }

    function renderParticipantsChips(){
      Array.from(participantsInput.querySelectorAll('.chip')).forEach(n=>n.remove());
      for(const p of participantsArr){
        const chip = document.createElement('span');
        chip.className='chip';
        chip.innerHTML = `<span>${escapeHTML(p.name)}<span style="opacity:.7">#${escapeHTML(p.id)}</span></span>`;
        const x = document.createElement('button');
        x.className='chipx'; x.type='button'; x.ariaLabel='Entfernen'; x.textContent='×';
        x.addEventListener('click', () => removeParticipantByKey(participantKey(p)));
        chip.appendChild(x);
        participantsInput.insertBefore(chip, participantText);
      }
      updateMemberCountInput(); // 👈 live aktualisieren
    }

    participantText.addEventListener('keydown', (e)=>{
      if(['Enter','Tab'].includes(e.key) || e.key === ',' || e.key === ';'){
        e.preventDefault();
        addParticipantFromText();
      }else if(e.key === 'Backspace' && participantText.value === '' && participantsArr.length){
        const last = participantsArr[participantsArr.length-1];
        removeParticipantByKey(participantKey(last));
      }
    });

    participantText.addEventListener('blur', ()=>{
      if(participantText.value.trim()) addParticipantFromText();
    });

    btnSubmit.onclick = async () => {
      setStatus("Speichere…");
      try{
        const type = (eventType.value||"").trim();
        const cnt  = participantsArr.length; // 👈 automatisch berechnet
        if(!type) return setStatus("Bitte eine Event-Art wählen.");
        if(!eventOptions.includes(type)) return setStatus("Ungültiges Event.");

        let proofUrl=(proofUrlInput.value||"").trim();
        if(proofUrl && !(/^https?:\/\//i.test(proofUrl))) return setStatus("Bitte gültige URL (http/https).");

        const payload={
          ts:new Date().toISOString(),
          serverTs:firebase.firestore.FieldValue.serverTimestamp(),
          type,
          memberCount:cnt,
          participants: participantsArr.slice(), // Array von {name,id}
          note:(note.value||"").trim(),
          proofUrl,
          reviewed:false,
          reviewedBy:null,
          reviewedTs:null
        };

        await db.collection('eventLogs').add(payload);
        try{ await sendDiscordLog(payload); }catch(e){ console.warn("Discord-Webhook Fehler:", e); }

        populateEventSelect(); 
        proofUrlInput.value=""; 
        note.value="";
        participantsArr = [];
        renderParticipantsChips(); // setzt auch memberCount -> 0

        setStatus("Gespeichert & an Discord gesendet.");
        setTimeout(()=>setStatus(""),2000);
      }catch(e){ setStatus("Fehler: "+(e.message||e)); }
    };

    // Realtime Liste
    db.collection('eventLogs').orderBy('serverTs','desc').limit(100).onSnapshot(snap=>{
      const frag=document.createDocumentFragment();
      let count=0;
      snap.forEach(doc=>{ frag.appendChild(renderItem(doc.id, doc.data())); count++; });
      listEl.innerHTML=""; listEl.appendChild(frag);
      counterEl.textContent = `${count} Einträge`;
    });

    function renderItem(id, d){
      const proof=d.proofUrl||"";
      const el=document.createElement('div'); el.className='item';

      // ✅ Toggle-Button (nur Admin)
      const doneBtn=document.createElement('button');
      doneBtn.className='donebtn admin-only';
      doneBtn.title = d.reviewed ? 'Als nicht bearbeitet markieren' : 'Als bearbeitet markieren';
      doneBtn.textContent = d.reviewed ? '✅' : '☑️';
      doneBtn.onclick = async ()=>{
        if(!auth.currentUser){ alert('Nur als Admin möglich.'); return; }
        try{
          const now = new Date();
          const patch = d.reviewed
            ? { reviewed:false, reviewedBy:null, reviewedTs:null }
            : { reviewed:true,  reviewedBy:auth.currentUser.email||auth.currentUser.uid, reviewedTs:now.toISOString() };
          await db.collection('eventLogs').doc(id).update(patch);
        }catch(e){
          alert('Konnte Status nicht ändern: ' + (e?.message||e));
        }
      };
      el.appendChild(doneBtn);

      // ❌ Lösch-Button (nur Admin)
      const delBtn=document.createElement('button');
      delBtn.className='delbtn admin-only'; delBtn.title='Event-Log löschen'; delBtn.textContent='✕';
      delBtn.onclick=async()=>{
        if(!auth.currentUser){ alert('Nur als Admin möglich.'); return; }
        const ok=confirm('Diesen Event-Log wirklich löschen?');
        if(!ok) return;
        try{ await db.collection('eventLogs').doc(id).delete(); }
        catch(e){ alert('Löschen fehlgeschlagen: ' + (e?.message||e)); }
      };
      el.appendChild(delBtn);

      // Thumbnail / Proof
      const thumb=document.createElement('div'); thumb.className='thumb';
      const isImg = isImageUrl(proof);
      if(proof && isImg){
        const img=document.createElement('img'); img.src=proof; img.alt='Proof';
        img.onerror=()=>{ thumb.innerHTML=`<a class="pill" href="${escapeAttr(proof)}" target="_blank" rel="noopener">Proof öffnen</a>`; };
        thumb.appendChild(img);
      }else{
        thumb.innerHTML = proof
          ? `<a class="pill" href="${escapeAttr(proof)}" target="_blank" rel="noopener">Proof öffnen</a>`
          : `<span class="pill" style="opacity:.8">Kein Proof</span>`;
      }

      const content=document.createElement('div'); content.className='content';

      // Teilnehmerliste aufbereiten
      const plist = Array.isArray(d.participants)
        ? d.participants.filter(p=>p && (p.name||p.id)).map(p=>({name:String(p.name||'').trim(), id:String(p.id||'').trim()}))
        : (d.participants ? String(d.participants).split(',').map(s=>{
            const m = s.trim().match(/^(.+?)\s*\((.+?)\)$/);
            return m ? {name:m[1], id:m[2]} : {name:s.trim(), id:''};
          }) : []);

      const pCount = plist.length;

      content.innerHTML=`
        <p class="title"><span class="evName">${escapeHTML(d.type||'')}</span></p>
        <div class="meta">
          <span>Mitglieder: <b class="count">${(d.memberCount||0).toLocaleString('de-DE')}</b></span>
          <span>Datum: <b>${formatDate(d.serverTs?.toDate ? d.serverTs.toDate() : d.ts)}</b></span>
        </div>
        ${d.note?`<div class="hint">Hinweis: ${escapeHTML(d.note)}</div>`:""}
        ${d.reviewed ? `<div class="review-badge">✅ Von Leaderschaft bearbeitet</div>` : ``}
        ${pCount ? `
          <details class="participants">
            <summary>Teilnehmer anzeigen (${pCount})</summary>
            <div class="plist">
              ${plist.map(p=>`
                <div class="pitem">
                  <span class="pname">${escapeHTML(p.name||'')}</span>
                  <span class="pid">${p.id?`ID: ${escapeHTML(p.id)}`:''}</span>
                </div>
              `).join('')}
            </div>
          </details>
        ` : ``}
      `;
      el.appendChild(thumb); el.appendChild(content);
      return el;
    }

    async function sendDiscordLog({type, memberCount, note, proofUrl, ts, participants}){
      const isImg = isImageUrl(proofUrl||"");
      const participantsText = Array.isArray(participants) && participants.length
        ? participants.map(p=>`${p.name} (${p.id})`).join(', ')
        : undefined;

      const embed = {
        title: `Neues Event: ${type}`,
        description: (note || "").trim() || undefined,
        color: 0x22c55e,
        timestamp: new Date(ts || Date.now()).toISOString(),
        fields: [
          { name: "Event", value: type, inline: true },
          { name: "Mitglieder", value: String(memberCount||0), inline: true },
          ...(participantsText ? [{ name: "Teilnehmer", value: participantsText, inline: false }] : []),
          ...(proofUrl ? [{ name: "Proof", value: proofUrl, inline: false }] : [])
        ],
        thumbnail: isImg ? { url: proofUrl } : undefined,
        footer: { text: "MS Auszahlungen · Event-Log" }
      };
      const body = { username: "MS-Eventlog System", embeds: [embed] };

      try{
        const r = await fetch(DISCORD_WEBHOOK, {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        if (!r.ok && r.status !== 204) throw new Error(`HTTP ${r.status}`);
      }catch{
        try{
          await fetch(DISCORD_WEBHOOK, {
            method: "POST", mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
        }catch{}
      }
    }

    function setStatus(msg){ statusEl.textContent = msg; }
    function formatDate(x){ try{ return (x instanceof Date?x:new Date(x)).toLocaleString('de-DE'); }catch{ return String(x); } }
    function escapeHTML(str){ return String(str).replace(/[&<>'"]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[s])); }
    function escapeAttr(str){ return String(str).replace(/["'\\`]/g,"_"); }
    function isImageUrl(u){ try{ return /\.(png|jpe?g|webp|gif|bmp|svg)$/i.test(new URL(u).pathname); }catch{ return false; } }
  </script>

  <!-- Partikel-Netz (Canvas) -->
  <script>
    (function(){
      const canvas = document.getElementById('netCanvas');
      const ctx = canvas.getContext('2d');
      let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      let particles = [];
      let w = 0, h = 0;

      function resize(){
        w = canvas.clientWidth;
        h = canvas.clientHeight;
        canvas.width = Math.floor(w * DPR);
        canvas.height = Math.floor(h * DPR);
        ctx.setTransform(DPR,0,0,DPR,0,0);

        const targetCount = Math.round((w*h)/9000);
        const max = window.matchMedia('(max-width: 900px)').matches ? 80 : 140;
        const min = 50;
        const theCount = Math.max(min, Math.min(max, targetCount));

        if (particles.length > theCount) particles.length = theCount;
        while (particles.length < theCount){ particles.push(makeParticle()); }
      }

      function makeParticle(){
        return { x: Math.random()*w, y: Math.random()*h, vx: (Math.random()*2-1)*0.25, vy: (Math.random()*2-1)*0.25, r: Math.random()*1.2 + 0.6 };
      }

      let MAX_D = 160;  let DOT_A = 0.85;  let LINK_A = 0.22;

      function step(){
        ctx.clearRect(0,0,w,h);

        ctx.beginPath();
        particles.forEach(p=>{
          p.x += p.vx; p.y += p.vy;
          if (p.x < -20 || p.x > w+20) p.vx *= -1;
          if (p.y < -20 || p.y > h+20) p.vy *= -1;
          ctx.moveTo(p.x + p.r, p.y);
          ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        });
        ctx.fillStyle = `rgba(255,255,255,${DOT_A})`;
        ctx.fill();

        for (let i=0;i<particles.length;i++){
          for (let j=i+1;j<particles.length;j++){
            const a = particles[i], b = particles[j];
            const dx = a.x-b.x, dy = a.y-b.y;
            const d2 = dx*dx + dy*dy;
            if (d2 < MAX_D*MAX_D){
              const alpha = 1 - Math.sqrt(d2)/MAX_D;
              ctx.beginPath();
              ctx.moveTo(a.x, a.y);
              ctx.lineTo(b.x, b.y);
              ctx.strokeStyle = `rgba(255,255,255,${alpha*LINK_A})`;
              ctx.lineWidth = 1;
              ctx.stroke();
            }
          }
        }
        requestAnimationFrame(step);
      }

      window.addEventListener('resize', resize, {passive:true});
      resize();
      requestAnimationFrame(step);
    })();
  </script>
</body>
</html>
