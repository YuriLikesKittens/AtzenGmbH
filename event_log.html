<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Event-Log · Einträge & Proof-Links</title>
  <style>
    :root{
      --bg:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2937;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
      --accent:#7c3aed; --accent2:#06b6d4; --danger:#ef4444;
      --green:#22c55e; --red:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(160deg,#0b1020 0%,#0f172a 100%);
         color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
         padding:24px 16px 40px;}
    .wrap{max-width:1100px;margin:0 auto}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
    h1{margin:0;font-size:clamp(22px,4vw,32px);font-weight:800}
    a.btn{display:inline-block;padding:10px 14px;border-radius:12px;
          background:linear-gradient(135deg,var(--accent),var(--accent2));
          color:#fff;text-decoration:none;font-weight:700;border:0}
    .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
          border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);
          padding:18px;backdrop-filter:blur(6px)}
    h2{margin:0 0 12px;font-size:18px}
    label{font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)}
    input,select,button{width:100%;padding:12px 14px;border-radius:12px;
                        border:1px solid var(--border);background:#0b1020;
                        color:#e5e7eb;outline:none;transition:.2s}
    input:focus,select:focus{border-color:#4c1d95;box-shadow:0 0 0 4px rgba(124,58,237,.2)}
    .btn{cursor:pointer;font-weight:700;background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 100%);
         border:none;margin-top:8px;box-shadow:0 6px 16px rgba(6,182,212,.35)}
    .btn:hover{transform:translateY(-1px);filter:brightness(1.05)}
    .muted{color:var(--muted);font-size:12px}

    /* Liste */
    .list{display:grid;grid-template-columns:1fr;gap:12px}
    .item{position:relative;display:grid;grid-template-columns:160px 1fr;gap:14px;
          border:1px solid var(--border);border-radius:14px;padding:12px;
          background:rgba(255,255,255,.03)}
    @media (max-width:640px){.item{grid-template-columns:1fr}}
    .thumb{width:100%;height:120px;max-width:160px;background:#0a0f1f;border:1px solid var(--border);
           border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .content{min-width:0}
    .title{margin:0 0 6px}
    .evName{font-weight:800;color:var(--green)}  /* Event grün */
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .count{color:var(--red);font-weight:700}     /* Mitglieder rot */
    .hint{font-size:12px;color:#9ca3af;margin-top:6px}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;
          padding:4px 8px;font-size:12px;color:#9ca3af;margin-top:6px}

    .admin-only{display:none}
    body.admin .admin-only{display:block}
    .delbtn{position:absolute;top:8px;right:8px;background:#0b1020;border:1px solid var(--border);
            color:#fca5a5;width:32px;height:32px;border-radius:999px;cursor:pointer}
    .delbtn:hover{background:#1f2937;color:#fff}

    /* Login Card */
    .authrow{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width:640px){.authrow{grid-template-columns:1fr}}
    /* Link-Button unter dem Proof-Feld */
    .linkbtn{display:inline-block;margin-top:6px;border:1px solid var(--border);border-radius:10px;
             padding:6px 10px;text-decoration:none;color:#e5e7eb}
    .linkbtn:hover{background:#111827}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Event-Log · Einträge & Proof-Links</h1>
      <a class="btn" href="https://yurilikeskittens.github.io/MS13Auszahlung/">Zur Übersicht</a>
    </div>

    <!-- Admin Login nur fürs Löschen -->
    <div class="card" id="authCard">
      <h2>Admin Login (nur zum Löschen)</h2>
      <div class="authrow">
        <div>
          <label>E-Mail</label>
          <input type="email" id="email" placeholder="admin@beispiel.de" />
        </div>
        <div>
          <label>Passwort</label>
          <input type="password" id="password" placeholder="********" />
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button class="btn" id="btnLogin">Anmelden</button>
        <button class="btn" id="btnLogout" style="display:none">Abmelden</button>
        <span class="muted" id="authState"></span>
      </div>
      <p class="muted" style="margin-top:6px">Hinweis: Login wird nicht gespeichert – nach Reload wieder abgemeldet.</p>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Neues Event eintragen</h2>
        <div class="row" style="display:grid;gap:12px;grid-template-columns:1fr 1fr">
          <div>
            <label>Art des Events</label>
            <select id="eventType"><option value="">— Bitte wählen —</option></select>
          </div>
          <div>
            <label>Mitglieder</label>
            <input type="number" id="memberCount" min="0" step="1" placeholder="z. B. 12" />
          </div>
        </div>
        <div class="row" style="display:grid;gap:12px;grid-template-columns:1fr 1fr">
          <div>
            <label>Proof-URL (optional)</label>
            <input type="url" id="proofUrl" placeholder="Hier Imgur Link einfügen" />
            <!-- NEU: schneller Link zu Imgur Upload -->
            <a class="linkbtn" href="https://imgur.com/upload" target="_blank" rel="noopener">Bild bei Imgur hochladen ↗</a>
            <div class="hint">Lade das Bild bei Imgur hoch und füge den Link hier ein.</div>
          </div>
          <div>
            <label>Bemerkung (optional)</label>
            <input type="text" id="note" placeholder="Anmerkungen" />
          </div>
        </div>
        <button class="btn" id="btnSubmit">Eintragen</button>
        <p class="muted" id="status"></p>
      </div>

      <div class="card">
        <h2>Letzte Events</h2>
        <div id="list" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBgPA5LV1ILz5MmyzUezVumMgOuWoxfNxo",
      authDomain: "msauszahlung.firebaseapp.com",
      projectId: "msauszahlung",
      storageBucket: "msauszahlung.appspot.com",
      messagingSenderId: "1033439801595",
      appId: "1:1033439801595:web:4251badc1447ed8079805e",
      measurementId: "G-FWXF3GM505"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /* Nur diese 10 Events auswählbar */
    const eventOptions = [
      "40er","50er","Bank","Bizwar","Cayo","EKZ/Mall","Gießerei","Hafen Drop","RP Fabrik","Waffenfabrik,"
    ];

    /* Discord Webhook */
    const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1411850377560592527/2V4Xmj0iJeLIsDUVkz9ow9KEFdvhU9cffPcQqZtJUfOmkFoBzj5kBAaYSn9zXhO17ocJ";

    // --- Admin Login nur fürs Löschen ---
    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const authState = document.getElementById('authState');

    let isAdmin = false;
    function setAdminUI(on){
      isAdmin = !!on;
      document.body.classList.toggle('admin', !!on);
      btnLogin.style.display = on ? 'none' : 'inline-block';
      btnLogout.style.display = on ? 'inline-block' : 'none';
      authState.textContent = on ? 'Angemeldet' : 'Abgemeldet';
    }

    btnLogin.onclick = async () => {
      authState.textContent = 'Anmeldung läuft…';
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
        await auth.signInWithEmailAndPassword(email.value, password.value);
        setAdminUI(true);
      }catch(e){
        authState.textContent = e?.message || 'Login fehlgeschlagen';
      }
    };
    btnLogout.onclick = async () => { await auth.signOut(); };
    auth.onAuthStateChanged(user => setAdminUI(!!user));
    // ------------------------------------

    // UI Refs
    const eventType = document.getElementById('eventType');
    const memberCount = document.getElementById('memberCount');
    const proofUrlInput = document.getElementById('proofUrl');
    const note = document.getElementById('note');
    const btnSubmit = document.getElementById('btnSubmit');
    const status = document.getElementById('status');
    const list = document.getElementById('list');

    // Dropdown auf die 10 Events setzen
    function populateEventSelect() {
      while (eventType.firstChild) eventType.removeChild(eventType.firstChild);
      const ph = document.createElement('option');
      ph.value = ""; ph.textContent = "— Bitte wählen —";
      eventType.appendChild(ph);
      for (const label of eventOptions) {
        const opt = document.createElement('option');
        opt.value = label; opt.textContent = label;
        eventType.appendChild(opt);
      }
    }
    document.addEventListener('DOMContentLoaded', populateEventSelect);

    btnSubmit.onclick=async()=>{
      setStatus("Speichere…");
      try{
        const type=eventType.value.trim();
        const cnt=parseInt(memberCount.value||"0",10);
        if(!type){return setStatus("Bitte eine Event-Art wählen.");}
        if(!eventOptions.includes(type)){return setStatus("Ungültiges Event.");}
        if(isNaN(cnt)||cnt<0){return setStatus("Mitgliederzahl ungültig.");}
        let proofUrl=(proofUrlInput.value||"").trim();
        if(proofUrl && !(proofUrl.startsWith("http://")||proofUrl.startsWith("https://"))){
          return setStatus("Bitte gültige URL (http/https).");
        }

        const payload={ts:new Date().toISOString(),serverTs:firebase.firestore.FieldValue.serverTimestamp(),
          type,memberCount:cnt,note:note.value||"",proofUrl};

        // 1) Firestore speichern
        await db.collection('eventLogs').add(payload);

        // 2) Discord Webhook (Embed)
        try{
          await sendDiscordLog(payload);
        }catch(e){
          console.warn("Discord-Webhook Fehler:", e);
        }

        populateEventSelect(); memberCount.value=""; proofUrlInput.value=""; note.value="";
        setStatus("Gespeichert & an Discord gesendet.");
        setTimeout(()=>setStatus(""),2000);
      }catch(e){ setStatus("Fehler: "+(e.message||e)); }
    };

    // Live-Liste inkl. (admin-only) Löschen
    db.collection('eventLogs').orderBy('serverTs','desc').limit(100).onSnapshot(snap=>{
      const frag=document.createDocumentFragment();
      snap.forEach(doc=>{
        frag.appendChild(renderItem(doc.id, doc.data()));
      });
      list.innerHTML=""; list.appendChild(frag);
    });

    function renderItem(id, d){
      const proof=d.proofUrl||"";
      const el=document.createElement('div');
      el.className='item';

      // Admin X Button
      const delBtn=document.createElement('button');
      delBtn.className='delbtn admin-only';
      delBtn.title='Event-Log löschen';
      delBtn.textContent='✕';
      delBtn.onclick=async()=>{
        if(!isAdmin){ alert('Nicht angemeldet.'); return; }
        const ok=confirm('Diesen Event-Log wirklich löschen?');
        if(!ok) return;
        try{
          await db.collection('eventLogs').doc(id).delete();
        }catch(e){
          alert('Löschen fehlgeschlagen: ' + (e?.message||e));
        }
      };
      el.appendChild(delBtn);

      // Thumbnail/Link
      const thumb=document.createElement('div');
      thumb.className='thumb';
      const isImg = isImageUrl(proof);
      if(proof && isImg){
        const img=document.createElement('img');
        img.src=proof; img.alt='Proof';
        img.onerror=()=>{ thumb.innerHTML=`<a class="pill" href="${escapeAttr(proof)}" target="_blank" rel="noopener">Proof öffnen</a>`; };
        thumb.appendChild(img);
      }else{
        thumb.innerHTML = proof
          ? `<a class="pill" href="${escapeAttr(proof)}" target="_blank" rel="noopener">Proof öffnen</a>`
          : `<span class="pill" style="opacity:.8">Kein Proof</span>`;
      }

      const content=document.createElement('div');
      content.className='content';
      content.innerHTML=`
        <p class="title"><span class="evName">${escapeHTML(d.type||'')}</span></p>
        <div class="meta">
          <span>Mitglieder: <b class="count">${(d.memberCount||0).toLocaleString('de-DE')}</b></span>
          <span>Datum: <b>${formatDate(d.serverTs?.toDate ? d.serverTs.toDate() : d.ts)}</b></span>
        </div>
        ${d.note?`<div class="hint">Hinweis: ${escapeHTML(d.note)}</div>`:""}
      `;

      el.appendChild(thumb);
      el.appendChild(content);
      return el;
    }

    /* ===== Discord Webhook Sender ===== */
    async function sendDiscordLog({type, memberCount, note, proofUrl, ts}){
      const isImg = isImageUrl(proofUrl||"");
      const embed = {
        title: `Neues Event: ${type}`,
        description: (note || "").trim() || undefined,
        color: 0x22c55e, // grün
        timestamp: new Date(ts || Date.now()).toISOString(),
        fields: [
          { name: "Event", value: type, inline: true },
          { name: "Mitglieder", value: String(memberCount||0), inline: true },
          ...(proofUrl ? [{ name: "Proof", value: proofUrl, inline: false }] : [])
        ],
        thumbnail: isImg ? { url: proofUrl } : undefined,
        footer: { text: "MS Auszahlungen · Event-Log" }
      };

      const body = {
        username: "MS-Eventlog System",
        avatar_url: "https://imgur.com/wuvue8S",
        embeds: [embed]
      };

      try{
        const r = await fetch(DISCORD_WEBHOOK, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        if (!r.ok && r.status !== 204) throw new Error(`HTTP ${r.status}`);
      }catch(err){
        try{
          await fetch(DISCORD_WEBHOOK, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
        }catch(e2){
          console.warn("Webhook no-cors Fallback fehlgeschlagen:", e2);
        }
      }
    }

    /* Helpers */
    function setStatus(msg){ status.textContent = msg; }
    function formatDate(x){ try{ return (x instanceof Date?x:new Date(x)).toLocaleString('de-DE'); }catch{ return String(x); } }
    function escapeHTML(str){ return String(str).replace(/[&<>'"]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','\"':'&quot;'}[s])); }
    function escapeAttr(str){ return String(str).replace(/["'\\`]/g,"_"); }
    function isImageUrl(u){ try{ return /\.(png|jpe?g|webp|gif|bmp|svg)$/i.test(new URL(u).pathname); }catch{ return false; } }
  </script>
</body>
</html>
