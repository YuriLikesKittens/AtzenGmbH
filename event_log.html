<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>📑 Event-Log</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --blue: 0,150,255;
      --text:#f5faff;
      --muted:#b0c4de;
      --card-bg: rgba(6,16,26,.82);
      --stroke: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; min-height:100%;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text); overflow-x:hidden;
      background-image: radial-gradient(#021027, #000000);
    }

    /* ===== Hintergrund-Bubbles von OBEN nach UNTEN ===== */
    .container{position:fixed; inset:0; width:100%; height:100%; overflow:hidden; z-index:-2;}
    .circle-container{position:absolute; animation-iteration-count:infinite; animation-timing-function:linear;}
    .circle{
      width:100%; height:100%; border-radius:50%; mix-blend-mode:screen;
      background-image: radial-gradient(hsl(180,100%,80%), hsl(180,100%,80%) 10%, hsla(180,100%,80%,0) 56%);
      animation: fade-frames 2s infinite, scale-frames 6s infinite;
    }
    @keyframes fade-frames{0%{opacity:1}50%{opacity:.6}100%{opacity:1}}
    @keyframes scale-frames{0%{transform:scale3d(.4,.4,1)}50%{transform:scale3d(2,2,1)}100%{transform:scale3d(.4,.4,1)}}

    /* ===== Spotlight ===== */
    .spotlight{
      position:fixed; width:800px; height:800px; border-radius:50%;
      pointer-events:none; mix-blend-mode:screen; transform:translate(-50%,-50%);
      background:radial-gradient(circle,
        rgba(var(--blue),.15) 0%, rgba(var(--blue),.08) 15%, rgba(var(--blue),.04) 25%,
        rgba(var(--blue),.02) 40%, rgba(var(--blue),.01) 65%, transparent 70%);
      opacity:0; z-index:2;
    }

    /* ===== Layout ===== */
    .wrap{max-width:1400px; margin:0 auto; position:relative; z-index:1; padding:24px 16px 40px;}
    @keyframes fadeUp{from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)}}

    /* ===== Header ===== */
    .header{
      text-align:center; margin:10px 0 32px;
      opacity:0; transform:translateY(-14px); animation:fadeUp .8s ease forwards; position:relative;
    }
    .header__title{
      font-family: Orbitron, sans-serif;
      font-size: clamp(28px, 6vw, 52px);
      color:#66cfff;
      text-shadow: 0 0 20px rgba(0,150,255,.8), 0 0 40px rgba(0,150,255,.6), 0 0 80px rgba(0,150,255,.4);
      margin:0;
    }
    .header__subtitle{font-size:16px; color:var(--muted); letter-spacing:2px; margin-top:8px;}
    .header::after{
      content:""; position:absolute; bottom:-14px; left:50%; transform:translateX(-50%);
      width:200px; height:4px; border-radius:4px;
      background:linear-gradient(90deg, transparent, #00aaff, transparent);
      box-shadow:0 0 20px rgba(0,150,255,.7);
    }

    /* ===== Buttons (Bubble/Neon) ===== */
    .btnrow{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:center;
      margin:32px 0 20px;
      opacity:0; transform:translateY(10px); animation:fadeUp .8s ease forwards; animation-delay:.35s;
    }
    a.btn, button.btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:999px;
      background:linear-gradient(135deg,#0096ff,#00e0ff);
      color:#fff; text-decoration:none; font-weight:800; border:1px solid rgba(255,255,255,.08); cursor:pointer;
      box-shadow:0 10px 26px rgba(0,150,255,.3), inset 0 0 0 1px rgba(255,255,255,.05);
      transition: transform .2s ease, filter .2s ease, box-shadow .2s ease;
      letter-spacing:.2px;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.05); box-shadow:0 14px 36px rgba(0,150,255,.5), inset 0 0 0 1px rgba(255,255,255,.08)}
    .btn-sm{padding:8px 12px; font-size:13px}
    .btn-icon{width:36px; height:36px; padding:0; border-radius:999px}

    /* ===== Cards ===== */
    .card{
      position:relative; background:var(--card-bg); border-radius:20px; padding:20px; margin-bottom:18px; overflow:hidden; text-align:left;
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 14px 36px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
      backdrop-filter: blur(8px) saturate(1.2);
      opacity:0; transform:translateY(16px); animation:fadeUp .8s ease forwards;
    }
    .card::before{
      content:""; position:absolute; inset:0; pointer-events:none;
      background:radial-gradient(circle at var(--glow-x,50%) var(--glow-y,50%), rgba(var(--blue), calc(var(--glow-intensity,0)*.6)) 0%, transparent 60%);
      opacity:.85; transition:opacity .2s ease;
    }

    /* ===== Inputs & Chip-Inputs ===== */
    label{display:block; font-size:12px; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); margin-bottom:6px}
    input,select{
      width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid var(--stroke); background:#09111a; color:var(--text); outline:none;
      transition:border-color .2s, box-shadow .2s;
    }
    input:focus,select:focus{border-color:#00aaff; box-shadow:0 0 0 4px rgba(0,150,255,.18)}
    .chip-input{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      padding:8px; border:1px solid var(--stroke); border-radius:12px; background:#09111a; min-height:46px
    }
    .chip-badge{
      background:#0b1020; border:1px solid var(--stroke); border-radius:999px; padding:6px 10px;
      font-size:12px; color:#a5d9ff; display:inline-flex; align-items:center; gap:6px;
    }
    .chipx{
      border:0; background:#13202e; color:#fff; border-radius:999px; cursor:pointer;
      width:18px; height:18px; line-height:18px; text-align:center; font-weight:900;
    }

    /* ===== Liste / Items ===== */
    .listwrap{border:1px solid var(--stroke); border-radius:12px; overflow:auto; max-height:70vh}
    .listhead{position:sticky; top:0; z-index:1; display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid var(--stroke); background:rgba(6,16,26,.9)}
    .list{display:grid; gap:12px; padding:12px}
    .item{
      display:grid; grid-template-columns:160px 1fr; gap:14px;
      border:1px solid rgba(255,255,255,.14); border-radius:14px; padding:12px; position:relative;
      background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
    }
    @media(max-width:640px){.item{grid-template-columns:1fr}}
    .thumb{width:100%; height:120px; max-width:160px; background:#0a0f1f; border:1px solid rgba(255,255,255,.14); border-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center}
    .thumb img{width:100%; height:100%; object-fit:cover}
    .content{min-width:0}
    .title{margin:0 0 6px; font-weight:800}
    .evName{font-weight:800; color:#9be7ff}
    .meta{display:flex; gap:12px; flex-wrap:wrap; font-size:12px; color:var(--muted)}
    .hint{font-size:12px; color:#a7b0bf; margin-top:6px}

    /* ===== Status-Badges ===== */
    .status-badge{display:inline-block; margin-top:6px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700}
    .badge-reviewed{background:rgba(34,197,94,.12); color:#86efac; border:1px solid rgba(34,197,94,.35)}
    .badge-rejected{background:rgba(239,68,68,.12); color:#fca5a5; border:1px solid rgba(239,68,68,.35)}
    .badge-nobank{background:rgba(59,130,246,.12); color:#93c5fd; border:1px solid rgba(59,130,246,.35)}
    .badge-noproof{background:rgba(251,191,36,.12); color:#fde68a; border:1px solid rgba(251,191,36,.35)}

    /* ===== Teilnehmer-Box ===== */
    details.participants{margin-top:8px; border:1px solid var(--stroke); border-radius:10px; background:#09111a}
    details.participants summary{cursor:pointer; padding:8px 10px; font-weight:800; color:#c7e5ff}
    .plist{padding:8px; display:grid; gap:6px}
    .pitem{display:flex; justify-content:space-between; gap:10px; border:1px solid rgba(255,255,255,.14); border-radius:8px; padding:6px 10px; background:#0b1020}
    .pname{font-weight:800; color:#e5f7ff}
    .pid{color:#93c5fd; font-family:ui-monospace,monospace}

    /* ===== Admin Buttons: Bubble-Style (nur sichtbar für Admin) ===== */
    .admin-tools{
      position:absolute; top:8px; right:8px; display:flex; gap:6px;
    }
    .admin-only{display:none}
    body.admin .admin-only{display:initial}
    .btn-ghost{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:36px; height:36px; padding:0 10px; border-radius:999px;
      background:linear-gradient(135deg,#0096ff,#00e0ff);
      color:#fff; font-weight:900; border:1px solid rgba(255,255,255,.08); cursor:pointer;
      box-shadow:0 8px 20px rgba(0,150,255,.28), inset 0 0 0 1px rgba(255,255,255,.05);
      transition:transform .2s ease, filter .2s ease, box-shadow .2s ease;
    }
    .btn-ghost:hover{transform:translateY(-1px); filter:brightness(1.05); box-shadow:0 12px 28px rgba(0,150,255,.45), inset 0 0 0 1px rgba(255,255,255,.08)}
    .btn-ghost span{font-size:14px; line-height:1}

    /* ===== Card-Particles (dekorativ) ===== */
    .particle{
      position:absolute; border-radius:50%; background:rgba(var(--blue),1); box-shadow:0 0 8px rgba(var(--blue),.6);
      pointer-events:none; z-index:0; opacity:.7; animation:floatParticle 4s ease-in-out infinite alternate;
    }
    @keyframes floatParticle{from{transform:translateY(0) scale(1); opacity:.8} to{transform:translateY(-25px) scale(1.3); opacity:.3}}

    /* ===== Footer RGB ===== */
    footer{
      text-align:center; margin-top:24px; font-size:13px; font-weight:600;
      background:linear-gradient(90deg, red, orange, yellow, green, cyan, blue, violet, red);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      background-size:400% 400%; animation:rgbFlow 10s linear infinite;
    }
    @keyframes rgbFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  </style>
</head>
<body>
  <!-- Hintergrund -->
  <div class="container" id="bg-container" aria-hidden="true"></div>
  <div class="spotlight" id="spotlight" aria-hidden="true"></div>

  <div class="wrap">
    <!-- Header -->
    <div class="header">
      <h1 class="header__title">📑 Event-Log</h1>
      <p class="header__subtitle">Log · Deine · Events</p>
    </div>

    <!-- Top Buttons -->
    <div class="btnrow">
      <a class="btn" href="index.html">🧭 Hauptseite</a>
      <button class="btn" id="btnAdminLogin">🔒 Leaderschaft-Login</button>
      <button class="btn" id="btnLogout" style="display:none">Abmelden</button>
    </div>

    <!-- Admin Popup (hidden by default) -->
    <div id="adminPopup" style="display:none; position:fixed; inset:0; z-index:999; background:rgba(0,0,0,.6); backdrop-filter:blur(4px); align-items:center; justify-content:center;">
      <div style="width:min(420px,92%); border-radius:16px; background:#0b1020; border:1px solid var(--stroke); box-shadow:0 18px 42px rgba(0,0,0,.5); padding:22px;">
        <h3 style="margin:0 0 12px; font-family:Orbitron,Inter">Admin Login</h3>
        <div style="display:grid; gap:10px; margin:12px 0">
          <label for="email">E-Mail</label>
          <input type="email" id="email" placeholder="admin@beispiel.de" />
          <label for="password">Passwort</label>
          <input type="password" id="password" placeholder="********" />
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" id="btnLogin">Anmelden</button>
          <button class="btn btn-sm" id="btnClosePopup">Schließen</button>
        </div>
        <p class="muted" id="authState" style="margin-top:8px"></p>
      </div>
    </div>

    <!-- Card: Neues Event -->
    <div class="card">
      <h2 style="margin:0 0 10px">Neues Event eintragen</h2>

      <div style="display:grid; gap:12px; grid-template-columns:1fr">
        <div>
          <label>Art des Events</label>
          <select id="eventType"><option value="">— Bitte wählen —</option></select>
        </div>

        <div>
          <label>Teilnehmer</label>
          <div id="participantsInput" class="chip-input">
            <input id="participantText" type="text" placeholder="Name#ID eingeben und Enter/Tab/Komma" />
          </div>
        </div>

        <div>
          <label>Proof-Links</label>
          <div id="proofsInput" class="chip-input">
            <input id="proofText" type="url" placeholder="https://… und Enter/Tab/Komma" />
          </div>
          <!-- Kleiner Bubble-Button -->
          <a href="https://imgur.com/upload" target="_blank" rel="noopener" class="btn btn-sm" style="margin-top:8px;display:inline-flex;">⬆️ Upload bei Imgur</a>
        </div>

        <div>
          <label>Bemerkung</label>
          <input type="text" id="note" placeholder="Optional" />
        </div>
      </div>

      <!-- Bubble-Submit -->
      <button class="btn" id="btnSubmit" style="margin-top:12px">Eintragen</button>
      <p class="muted" id="status" style="margin-top:6px"></p>
    </div>

    <!-- Card: Letzte Events -->
    <div class="card">
      <h2 style="margin:0 0 10px">Letzte Events</h2>
      <div class="listwrap">
        <div class="listhead">
          <span class="muted">Neueste zuerst</span>
          <span class="muted" id="counter">0 Einträge</span>
        </div>
        <div id="list" class="list"></div>
      </div>
    </div>

    <footer>Made by Alvaro SolanoHebel | 20367</footer>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    /* ==== Firebase Init (Logout bei Refresh) ==== */
    const firebaseConfig={apiKey:"AIzaSyBgPA5LV1ILz5MmyzUezVumMgOuWoxfNxo",authDomain:"msauszahlung.firebaseapp.com",projectId:"msauszahlung",storageBucket:"msauszahlung.appspot.com",messagingSenderId:"1033439801595",appId:"1:1033439801595:web:4251badc1447ed8079805e",measurementId:"G-FWXF3GM505"};
    try{firebase.initializeApp(firebaseConfig);}catch(e){}
    const auth=firebase.auth(); const db=firebase.firestore();
    auth.setPersistence(firebase.auth.Auth.Persistence.NONE).catch(()=>{}); // keine Persistenz => Logout beim Refresh

    /* ==== Discord Webhooks (Routing) ==== */
    /* DEFAULT = Angefahrene Events */
    const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1416741503253872801/2H75_WDeGl2k8K5zDwHWRLlZX8Il2XXOdI658Slo45OmUNxYX_x551T0fNCEXtVdAFz-";
    /* Spezielle Channels */
    const WEBHOOKS = {
      "40er":  "https://discord.com/api/webhooks/1416741181152432148/ElS3YqwlR6HygQGk0zc98L0h6J-2OONZu68_595U9IZeeSdJvyEESG9gGJS2j5ATgsxl",
      "Bizwar":"https://discord.com/api/webhooks/1416741309917560852/9fYnthXUW0vtBbcrmrhIT6xIhEC_K4TV1h5QEWI4P2GDS5Lx3uLa5r8URnwMatTZn3tf"
    };

    /* ==== Helpers ==== */
    const $=s=>document.querySelector(s);
    function escapeHTML(str){return String(str).replace(/[&<>'"]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[s]))}
    function escapeAttr(str){return String(str).replace(/["'\\`]/g,"_")}
    function isImageUrl(u){try{return/\.(png|jpe?g|webp|gif|bmp|svg)$/i.test(new URL(u).pathname)}catch{return false}}
    function normalizeUrl(u){try{const url=new URL(String(u).trim());if(!/^https?:$/i.test(url.protocol))return null;return url.toString()}catch{return null}}
    function shortName(email){if(!email)return'';const pre=email.split('@')[0]||'';return pre.charAt(0).toUpperCase()+pre.slice(1)}
  </script>

  <script>
    /* ==== Admin Popup / Auth ==== */
    const popup=$("#adminPopup");
    const btnAdminLogin=$("#btnAdminLogin");
    const btnLogout=$("#btnLogout");
    const btnLogin=$("#btnLogin");
    const btnClosePopup=$("#btnClosePopup");
    const authState=$("#authState");

    btnAdminLogin.onclick=()=>{ popup.style.display='flex'; };
    btnClosePopup.onclick=()=>{ popup.style.display='none'; };
    popup.addEventListener('click',(e)=>{ if(e.target===popup) popup.style.display='none'; });

    btnLogin.onclick=async()=>{
      authState.textContent='Anmeldung…';
      try{
        await auth.signInWithEmailAndPassword($("#email").value,$("#password").value);
        authState.textContent='Angemeldet.'; setTimeout(()=>popup.style.display='none',300);
      }catch(e){ authState.textContent = e?.message || 'Login fehlgeschlagen'; }
    };
    btnLogout.onclick=()=>auth.signOut();

    auth.onAuthStateChanged(user=>{
      document.body.classList.toggle('admin', !!user);
      btnLogout.style.display = user ? 'inline-flex' : 'none';
      authState.textContent = user ? `Angemeldet als ${shortName(user.email)}` : 'Abgemeldet';
    });
  </script>

  <script>
    /* ==== Event-Form: Optionen, Chips, Submit + Discord ==== */
    const eventOptions=["40er","50er","Bank","Bizwar","Cayo","EKZ/Mall","Gießerei","Hafen Drop","RP Fabrik","Waffenfabrik","Raid / Angriff","Raid / Verteidigung","Famwar","Drogenlabor Angriff","Flugzeugträger","Shop / Ammu Raub","Zinken","Staatliche Übernahme", "Übernahme des Hotels"];
    const eventType=$("#eventType"); for(const o of eventOptions){const opt=document.createElement('option'); opt.value=o; opt.textContent=o; eventType.appendChild(opt);}

    // Teilnehmer Chips
    const participantsInput=$("#participantsInput"); const participantText=$("#participantText");
    let participantsArr=[];
    function parseParticipant(v){const m=String(v||'').trim().match(/^(.+?)\s*#\s*([A-Za-z0-9_-]{1,32})$/); return m?{name:m[1].trim(), id:m[2].trim()} : null;}
    function renderParticipants(){
      [...participantsInput.querySelectorAll('.chip-badge')].forEach(n=>n.remove());
      for(const p of participantsArr){
        const chip=document.createElement('span'); chip.className='chip-badge';
        chip.innerHTML=`<span>${escapeHTML(p.name)}<span style="opacity:.7">#${escapeHTML(p.id)}</span></span>`;
        const x=document.createElement('button'); x.className='chipx'; x.textContent='×';
        x.onclick=()=>{participantsArr=participantsArr.filter(z=>z!==p); renderParticipants();};
        chip.appendChild(x);
        participantsInput.insertBefore(chip, participantText);
      }
    }
    function addParticipantFromInput(){
      const p=parseParticipant(participantText.value);
      if(!p){participantText.style.boxShadow='0 0 0 4px rgba(0,150,255,.18)'; setTimeout(()=>participantText.style.boxShadow='',160); return;}
      if(!participantsArr.some(x=>x.name.toLowerCase()===p.name.toLowerCase() && x.id.toLowerCase()===p.id.toLowerCase())){
        participantsArr.push(p); renderParticipants();
      }
      participantText.value='';
    }
    participantText.addEventListener('keydown',e=>{
      if(['Enter','Tab',',',';'].includes(e.key)){e.preventDefault(); addParticipantFromInput();}
      else if(e.key==='Backspace' && !participantText.value && participantsArr.length){participantsArr.pop(); renderParticipants();}
    });
    participantText.addEventListener('blur',()=>{ if(participantText.value.trim()) addParticipantFromInput(); });

    // Proof Chips
    const proofsInput=$("#proofsInput"); const proofText=$("#proofText");
    let proofsArr=[];
    function renderProofs(){
      [...proofsInput.querySelectorAll('.chip-badge')].forEach(n=>n.remove());
      for(const u of proofsArr){
        const chip=document.createElement('span'); chip.className='chip-badge';
        chip.innerHTML=`<span>${isImageUrl(u)?'Bild':'Link'}</span><a href="${escapeAttr(u)}" target="_blank" rel="noopener" style="color:#c7e5ff;text-decoration:none;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHTML(u)}</a>`;
        const x=document.createElement('button'); x.className='chipx'; x.textContent='×';
        x.onclick=()=>{proofsArr=proofsArr.filter(z=>z!==u); renderProofs();};
        chip.appendChild(x);
        proofsInput.insertBefore(chip, proofText);
      }
    }
    function addProofFromInput(){
      const u=normalizeUrl(proofText.value);
      if(!u){proofText.style.boxShadow='0 0 0 4px rgba(0,150,255,.18)'; setTimeout(()=>proofText.style.boxShadow='',160); return;}
      if(!proofsArr.includes(u)){proofsArr.push(u); renderProofs();}
      proofText.value='';
    }
    proofText.addEventListener('keydown',e=>{
      if(['Enter','Tab',',',';'].includes(e.key)){e.preventDefault(); addProofFromInput();}
      else if(e.key==='Backspace' && !proofText.value && proofsArr.length){proofsArr.pop(); renderProofs();}
    });
    proofText.addEventListener('blur',()=>{ if(proofText.value.trim()) addProofFromInput(); });

    // Discord Webhook Sender
    async function sendDiscordLog({type, memberCount, note, proofUrls, ts, participants}){
      const proofs = Array.isArray(proofUrls) && proofUrls.length ? proofUrls : [];
      const first = proofs[0];
      const firstIsImg = first && (/\.(png|jpe?g|webp|gif|bmp|svg)$/i.test(first));
      const participantsText = Array.isArray(participants) && participants.length
        ? participants.map(p=>`${p.name} (${p.id})`).join(', ')
        : '—';

      const fields = [
        { name: "Event", value: type || "—", inline: true },
        { name: "Mitglieder", value: String(memberCount||0), inline: true },
      ];
      if (participantsText && participantsText !== '—') fields.push({ name: "Teilnehmer", value: participantsText, inline: false });
      if (proofs.length) proofs.forEach((u,i)=>fields.push({ name:`Proof ${i+1}`, value:u, inline:false }));

      const embed = {
        title: `Neues Event: ${type}`,
        description: (note || "").trim() || undefined,
        color: 0x22c55e,
        timestamp: new Date(ts || Date.now()).toISOString(),
        fields,
        thumbnail: firstIsImg ? { url:first } : undefined,
        footer: { text: "MS Auszahlungen · Event-Log" }
      };
      const body = { username: "MS-Eventlog System", embeds: [embed] };

      // Routing
      const webhookUrl = WEBHOOKS[type] || DISCORD_WEBHOOK;

      try{
        const r = await fetch(webhookUrl, {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        if (!r.ok && r.status !== 204) throw new Error(`HTTP ${r.status}`);
      }catch(e){
        // Fallback (no-cors)
        try{
          await fetch(webhookUrl, {
            method: "POST", mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
        }catch(_){}
        console.warn("Discord-Webhook Fehler:", e);
      }
    }

    // Submit
    const note=$("#note"), statusEl=$("#status");
    $("#btnSubmit").onclick = async ()=>{
      const type=(eventType.value||'').trim();
      if(!type){statusEl.textContent='Bitte eine Event-Art wählen.'; return;}
      const payload={
        ts:new Date().toISOString(),
        serverTs:firebase.firestore.FieldValue.serverTimestamp(),
        type,
        memberCount:participantsArr.length,
        participants:participantsArr.slice(),
        proofUrls:proofsArr.slice(),
        note:(note.value||'').trim(),
        reviewed:false, reviewedBy:null, reviewedTs:null,
        rejected:false, noPayout:false, proofRejected:false
      };
      statusEl.textContent='Speichere…';
      try{
        await db.collection('eventLogs').add(payload);
        // Discord senden (best effort)
        sendDiscordLog(payload);
        // Reset
        participantsArr=[]; proofsArr=[]; renderParticipants(); renderProofs(); note.value=''; eventType.value='';
        statusEl.textContent='Gespeichert & an Discord gesendet.'; setTimeout(()=>statusEl.textContent='',1800);
      }catch(e){ statusEl.textContent='Fehler: '+(e.message||e); }
    };
  </script>

  <script>
    /* ==== Event-Liste + Admin-Action-Buttons (Bubble-Style) ==== */
    const list=$("#list"); const counter=$("#counter");

    db.collection('eventLogs').orderBy('serverTs','desc').limit(100).onSnapshot(snap=>{
      list.innerHTML=''; let count=0;
      snap.forEach(doc=>{ count++; list.appendChild(renderItem(doc.id, doc.data())); });
      counter.textContent = `${count} Einträge`;
    });

    function renderItem(id,d){
      const proofs = Array.isArray(d.proofUrls) ? d.proofUrls.filter(Boolean) : (d.proofUrl ? [d.proofUrl] : []);
      const firstProof = proofs[0] || "";
      const el = document.createElement('div'); el.className='item';

      /* Admin Button-Gruppe */
      const tools = document.createElement('div'); tools.className = 'admin-tools admin-only';

      const btnDone = document.createElement('button'); btnDone.className='btn-ghost'; btnDone.title='Als bearbeitet markieren';
      btnDone.innerHTML = '<span>✅</span>';
      btnDone.onclick=async()=>{
        if(!auth.currentUser){alert('Nur Admin.');return;}
        const now=new Date();
        const patch=d.reviewed ? {reviewed:false, reviewedBy:null, reviewedTs:null}
                               : {reviewed:true,  reviewedBy:auth.currentUser.email||null, reviewedTs:now.toISOString()};
        await db.collection('eventLogs').doc(id).update(patch);
      };
      tools.appendChild(btnDone);

      const btnReject = document.createElement('button'); btnReject.className='btn-ghost'; btnReject.title='Ablehnen/Zurücknehmen';
      btnReject.innerHTML='<span>❌</span>';
      btnReject.onclick=async()=>{ if(!auth.currentUser){alert('Nur Admin.');return;} await db.collection('eventLogs').doc(id).update({rejected:!d.rejected}); };
      tools.appendChild(btnReject);

      const btnNoBank = document.createElement('button'); btnNoBank.className='btn-ghost'; btnNoBank.title='Keine Auszahlung toggeln';
      btnNoBank.innerHTML='<span>💸</span>';
      btnNoBank.onclick=async()=>{ if(!auth.currentUser){alert('Nur Admin.');return;} await db.collection('eventLogs').doc(id).update({noPayout:!d.noPayout}); };
      tools.appendChild(btnNoBank);

      const btnNoProof = document.createElement('button'); btnNoProof.className='btn-ghost'; btnNoProof.title='Proof nicht akzeptiert toggeln';
      btnNoProof.innerHTML='<span>🛡️</span>';
      btnNoProof.onclick=async()=>{ if(!auth.currentUser){alert('Nur Admin.');return;} await db.collection('eventLogs').doc(id).update({proofRejected:!d.proofRejected}); };
      tools.appendChild(btnNoProof);

      const btnDel = document.createElement('button'); btnDel.className='btn-ghost'; btnDel.title='Löschen';
      btnDel.innerHTML='<span>✕</span>';
      btnDel.onclick=async()=>{ if(!auth.currentUser){alert('Nur Admin.');return;} if(!confirm('Diesen Eintrag wirklich löschen?')) return; await db.collection('eventLogs').doc(id).delete(); };
      tools.appendChild(btnDel);

      el.appendChild(tools);

      /* Thumbnail */
      const thumb=document.createElement('div'); thumb.className='thumb';
      if(firstProof && isImageUrl(firstProof)){ thumb.innerHTML = `<img src="${escapeAttr(firstProof)}" alt="Proof">`; }
      else if(firstProof){ thumb.innerHTML = `<a href="${escapeAttr(firstProof)}" target="_blank" rel="noopener" class="btn btn-sm">Proof öffnen</a>`; }
      else{ thumb.innerHTML = `<span style="opacity:.7">Kein Proof</span>`; }

      /* Content */
      const content=document.createElement('div'); content.className='content';
      const date = d.serverTs?.toDate ? d.serverTs.toDate() : (d.ts ? new Date(d.ts) : new Date());

      // Teilnehmerliste
      const plist = Array.isArray(d.participants)
        ? d.participants.filter(p=>p && (p.name||p.id)).map(p=>({name:String(p.name||'').trim(), id:String(p.id||'').trim()}))
        : [];

      // Badges (inkl. „Bearbeitet von …“)
      const badges = [
        d.reviewed ? `<div class="status-badge badge-reviewed">✅ Bearbeitet${d.reviewedBy?` von ${escapeHTML(shortName(d.reviewedBy))}`:''}</div>` : ``,
        d.rejected ? `<div class="status-badge badge-rejected">❌ Abgelehnt</div>` : ``,
        d.noPayout ? `<div class="status-badge badge-nobank">💸 Keine Auszahlung</div>` : ``,
        d.proofRejected ? `<div class="status-badge badge-noproof">🛡️ Proof nicht akzeptiert</div>` : ``,
      ].join("");

      // Weitere Proofs ab #2
      const moreProofs = proofs.slice(1);
      const proofGridHTML = moreProofs.length ? `
        <div class="proofgrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:8px">
          ${moreProofs.map(u=> isImageUrl(u)
            ? `<div class="proofcell" style="border:1px solid rgba(255,255,255,.14);border-radius:10px;overflow:hidden;background:#0b1020"><img src="${escapeAttr(u)}" alt="Proof" style="width:100%;height:90px;object-fit:cover"></div>`
            : `<div class="proofcell" style="border:1px solid rgba(255,255,255,.14);border-radius:10px;overflow:hidden;background:#0b1020"><a class="btn btn-sm" href="${escapeAttr(u)}" target="_blank" rel="noopener" style="display:block;text-align:center">Proof öffnen</a></div>`
          ).join('')}
        </div>` : ``;

      content.innerHTML = `
        <p class="title"><span class="evName">${escapeHTML(d.type||'Event')}</span></p>
        <div class="meta">👥 ${Number(d.memberCount||0)} · 📅 ${date.toLocaleString('de-DE')}</div>
        ${d.note?`<div class="hint">📝 ${escapeHTML(d.note)}</div>`:""}
        ${badges}
        ${plist.length?`
          <details class="participants">
            <summary>Teilnehmer anzeigen (${plist.length})</summary>
            <div class="plist">
              ${plist.map(p=>`
                <div class="pitem">
                  <span class="pname">${escapeHTML(p.name)}</span>
                  <span class="pid">${p.id?`ID: ${escapeHTML(p.id)}`:''}</span>
                </div>
              `).join('')}
            </div>
          </details>`:""}
        ${proofGridHTML}
      `;

      el.appendChild(thumb);
      el.appendChild(content);
      return el;
    }
  </script>

  <script>
    /* ==== Spotlight & Karten-Glow + Partikel ==== */
    const spotlight = document.getElementById('spotlight');
    const cards = document.querySelectorAll('.card');

    document.addEventListener('mousemove', e => {
      spotlight.style.left = e.clientX + 'px';
      spotlight.style.top = e.clientY + 'px';
      spotlight.style.opacity = 1;

      cards.forEach(card => {
        const rect = card.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        card.style.setProperty('--glow-x', x + '%');
        card.style.setProperty('--glow-y', y + '%');
        card.style.setProperty('--glow-intensity', '1');
      });
    });

    // Card-Particles (Deko)
    cards.forEach(card => {
      for (let i=0; i<20; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        const size = 3 + Math.random()*6;
        p.style.width = size+'px';
        p.style.height = size+'px';
        p.style.left = Math.random()*(card.offsetWidth-size)+'px';
        p.style.top = Math.random()*(card.offsetHeight-size)+'px';
        p.style.animationDuration = (3+Math.random()*4)+'s';
        p.style.animationDelay = (Math.random()*4)+'s';
        card.appendChild(p);
      }
    });
  </script>

  <script>
    /* ==== Hintergrund-Bubbles nach unten ==== */
    (function(){
      const container=document.getElementById('bg-container');
      const num=110;
      for(let i=0;i<num;i++){
        const c=document.createElement('div'); c.className='circle-container';
        const circle=document.createElement('div'); circle.className='circle'; c.appendChild(circle);
        const size=Math.random()*8+4; c.style.width=size+'px'; c.style.height=size+'px';
        const startX=Math.random()*100, endX=Math.random()*100;
        const startY=-30-Math.random()*20, endY=120+Math.random()*20;
        const dur=7000+Math.random()*5000; const name=`move-${i}`;
        const css=`@keyframes ${name}{from{transform:translate3d(${startX}vw,${startY}vh,0);}to{transform:translate3d(${endX}vw,${endY}vh,0);}}`;
        const s=document.createElement('style'); s.innerHTML=css; document.head.appendChild(s);
        c.style.animationName=name; c.style.animationDuration=dur+'ms'; c.style.animationDelay='0ms';
        container.appendChild(c);
      }
    })();
  </script>
</body>
</html>
