<!DOCTYPE html>
<html lang="de" data-theme="custom">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderschaftspanel f√ºr Auszahlungen</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --surface-1:rgba(14,18,27,.72);
      --surface-2:rgba(9,13,22,.78);
      --border:#1a2333;
      --shadow-elev:0 12px 40px rgba(0,0,0,.42);
      --radius-lg:18px;
      --radius-md:12px;
      --radius-pill:999px;
      --text:#eef2ff;
      --text-muted:#9aa3b2;
      --danger:#ef4444;
      --font-ui: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);font-family:var(--font-ui);
      padding:28px 16px 48px;
      background:
        radial-gradient(1200px 1200px at 10% -20%, #1e293b 0%, transparent 60%),
        radial-gradient(1000px 800px at 120% 10%, #0ea5e9 0%, transparent 45%),
        linear-gradient(160deg, #0b1020 0%, var(--bg) 100%);
      overflow-x:hidden;
    }
    .net-bg{position:fixed;inset:0;z-index:0;pointer-events:none}
    .net-bg canvas{width:100%;height:100%;display:block}

    .container{max-width:1120px;margin:0 auto;position:relative;z-index:1}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
    h1{
      margin:0;font-size:clamp(22px,4vw,34px);letter-spacing:.2px;font-weight:800;
      background:linear-gradient(120deg,#fff,#a5b4fc 40%,#67e8f9 80%);
      -webkit-background-clip:text;background-clip:text;color:transparent;
    }
    .subtitle{color:var(--text-muted);margin:6px 0 18px}

    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.045),rgba(255,255,255,.02));
      border:1px solid var(--border);border-radius:var(--radius-lg);
      box-shadow:var(--shadow-elev);padding:20px;backdrop-filter:blur(6px);margin-bottom:18px;
    }
    h2{margin:0 0 12px;font-size:18px}

    label{
      font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:var(--text-muted);
      display:block;margin-bottom:6px;
    }
    input,select,button,a.btn{
      width:100%;padding:12px 14px;border-radius:var(--radius-md);
      border:1px solid var(--border);background:var(--surface-2);color:var(--text);
      outline:none;transition:.18s ease;display:inline-block;text-align:center;text-decoration:none;
    }
    input::placeholder{color:color-mix(in srgb, var(--text-muted) 85%, white 15%)}
    input:focus,select:focus{border-color:color-mix(in srgb, #8b5cf6 70%, black 30%);box-shadow:0 0 0 4px rgba(139,92,246,.25)}

    /* Sch√∂ne Buttons mit animierten Farbverl√§ufen */
    .btn{
      cursor:pointer;font-weight:700;border:none;border-radius:var(--radius-pill);
      padding:12px 18px;font-size:15px;display:inline-flex;align-items:center;justify-content:center;gap:8px;
      transition:all 0.3s ease;box-shadow:0 3px 8px rgba(0,0,0,0.25);
      background-size:200% 200%;
    }
    .btn span.emoji{font-size:18px}
    .btn-blue{background:linear-gradient(270deg,#3b82f6,#2563eb,#3b82f6);color:#fff}
    .btn-green{background:linear-gradient(270deg,#22c55e,#15803d,#22c55e);color:#fff}
    .btn-yellow{background:linear-gradient(270deg,#facc15,#eab308,#facc15);color:#111}
    .btn-danger{background:linear-gradient(270deg,#ef4444,#b91c1c,#ef4444);color:#fff}
    .btn:hover{transform:translateY(-2px) scale(1.03);box-shadow:0 6px 16px rgba(0,0,0,0.35);animation:gradientMove 3s linear infinite}
    .btn:active{transform:translateY(0) scale(0.97)}
    @keyframes gradientMove{0%{background-position:0% 50%}100%{background-position:200% 50%}}

    .actions{display:flex;gap:12px;flex-wrap:wrap}

    .stats{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
    .chip{display:inline-flex;gap:8px;align-items:center;background:var(--surface-2);border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:13px;color:var(--text-muted)}
    .chip b{color:#e2e8f0}

    .table-shell{overflow:auto;max-height:56vh;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;background:var(--surface-2);border-bottom:1px solid var(--border);font-size:12px;letter-spacing:.06em;text-transform:uppercase;color:var(--text-muted);padding:12px 10px;text-align:left}
    tbody td{padding:12px 10px;border-bottom:1px dashed #1f2a44;vertical-align:middle}
    tbody tr:hover{background:color-mix(in srgb, #8b5cf6 12%, transparent)}
    .right{text-align:right}

    .xbtn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:var(--radius-pill);border:1px solid var(--border);background:var(--surface-2);cursor:pointer;transition:.18s}
    .xbtn:hover{background:#1f2937}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal-overlay.active{display:flex}
    .modal{background:var(--surface-1);border:1px solid var(--border);border-radius:18px;padding:20px;width:100%;max-width:520px;box-shadow:var(--shadow-elev);animation:fadeIn .2s ease}
    .row{display:grid;gap:12px}
    .row-2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width:680px){.row-2{grid-template-columns:1fr}}
    .muted{color:var(--text-muted);font-size:12px}
    .warn{color:#fca5a5;font-size:12px}
    @keyframes fadeIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}

    footer{
      margin-top:24px;text-align:center;font-size:13px;padding:10px;font-weight:600;
      background: linear-gradient(90deg, rgb(255,0,0), rgb(0,255,0), rgb(0,0,255));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; color: transparent; animation: rgbMove 6s linear infinite; background-size: 300% 100%;
    }
    @keyframes rgbMove{0%{background-position:0 0}100%{background-position:100% 0}}
  </style>
</head>
<body>
  <!-- Hintergrund -->
  <div class="net-bg" aria-hidden="true"><canvas id="netCanvas"></canvas></div>

  <div class="container">
    <div class="topbar">
      <h1>Admin ¬∑ Guthaben Verwaltung (Sync)</h1>
    </div>
    <p class="subtitle">Verwalte Mitglieder und Auszahlungen ‚Äì mit gef√ºhrten Workflows.</p>

    <!-- Login -->
    <div class="card" id="authCard">
      <h2>Admin Login</h2>
      <div class="row-2">
        <div>
          <label>E-Mail</label>
          <input type="email" id="email" placeholder="admin@beispiel.de" />
        </div>
        <div>
          <label>Passwort</label>
          <input type="password" id="password" placeholder="********" />
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button class="btn btn-blue" id="btnLogin"><span class="emoji">üîë</span> Anmelden</button>
        <button class="btn btn-danger" id="btnLogout" style="display:none"><span class="emoji">üö™</span> Abmelden</button>
      </div>
      <p class="muted">Status: <span class="warn" id="authState">Abgemeldet</span></p>
    </div>

    <!-- Aktionen -->
    <div class="card" id="app" style="display:none">
      <h2>Aktionen</h2>
      <div class="actions">
        <button class="btn btn-blue" id="btnAddMember"><span class="emoji">‚úçÔ∏è</span> Neues Mitglied hinzuf√ºgen</button>
        <button class="btn btn-green" id="btnPayout"><span class="emoji">üíµ</span> Ein Mitglied auszahlen</button>
        <button class="btn btn-yellow" id="btnPending"><span class="emoji">‚è≥</span> Eine Offene Auszahlung hinzuf√ºgen</button>
      </div>
    </div>

    <!-- √úbersicht -->
    <div class="card" id="overview" style="display:none">
      <h2>√úbersicht</h2>
      <div class="stats">
        <span class="chip">Mitglieder: <b id="statMitglieder">0</b></span>
        <span class="chip">Gesamtsaldo: <b id="statSaldo">0</b> ‚Ç¨</span>
      </div>
      <div class="table-shell">
        <table>
          <thead>
            <tr>
              <th>Mitglied</th>
              <th>ID</th>
              <th class="right">Kontostand (‚Ç¨)</th>
              <th class="right">Aktion</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <p class="muted" style="margin-top:8px">Hinweis: Entfernen l√∂scht das Mitglied aus der √úbersicht. <b>Transaktionen bleiben erhalten</b>.</p>
    </div>
  </div>
  <!-- Modal: Mitglied hinzuf√ºgen -->
  <div id="addMemberModal" class="modal-overlay">
    <div class="modal">
      <h3>Mitglied hinzuf√ºgen</h3>
      <div class="row" id="addStep1">
        <div>
          <label>Name</label>
          <input type="text" id="addName" placeholder="z. B. Max Mustermann" />
        </div>
        <button class="btn btn-blue" id="addToStep2">Weiter</button>
      </div>
      <div class="row" id="addStep2" style="display:none">
        <div>
          <label>ID</label>
          <input type="text" id="addId" placeholder="z. B. M001" />
        </div>
        <div class="muted" id="addConfirmText">M√∂chtest du <b id="addCName"></b> mit der ID <b id="addCId"></b> hinzuf√ºgen?</div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-blue" id="addConfirm">Best√§tigen</button>
          <button class="btn btn-yellow" id="addCancel">Abbrechen</button>
        </div>
        <p class="warn" id="addWarn" style="display:none">‚ö†Ô∏è Mitglied existiert bereits!</p>
      </div>
    </div>
  </div>

  <!-- Modal: Auszahlung -->
  <div id="payoutModal" class="modal-overlay">
    <div class="modal">
      <h3>Mitglied auszahlen</h3>
      <div class="row" id="payoutStep1">
        <div>
          <label>W√§hle ein Mitglied</label>
          <select id="payoutMember"></select>
        </div>
        <button class="btn btn-green" id="payoutToStep2">Weiter</button>
      </div>
      <div class="row" id="payoutStep2" style="display:none">
        <div>
          <label>W√§hle das Event</label>
          <select id="payoutEvent"></select>
        </div>
        <button class="btn btn-green" id="payoutToStep3">Weiter</button>
      </div>
      <div class="row" id="payoutStep3" style="display:none">
        <div>
          <label>Betrag (‚Ç¨)</label>
          <input type="number" id="payoutAmount" step="0.01" />
          <p class="muted">Betrag wird durch Template gesetzt, kann aber manuell angepasst werden.</p>
        </div>
        <div class="muted" id="payoutSummary"></div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-green" id="payoutConfirm">Best√§tigen</button>
          <button class="btn btn-yellow" id="payoutCancel">Abbrechen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Offene Auszahlung -->
  <div id="pendingModal" class="modal-overlay">
    <div class="modal">
      <h3>Offene Auszahlung</h3>
      <div class="row" id="pendingStep1">
        <div>
          <label>W√§hle ein Mitglied</label>
          <select id="pendingMember"></select>
        </div>
        <button class="btn btn-yellow" id="pendingToStep2">Weiter</button>
      </div>
      <div class="row" id="pendingStep2" style="display:none">
        <div>
          <label>W√§hle das Event</label>
          <select id="pendingEvent"></select>
        </div>
        <button class="btn btn-yellow" id="pendingToStep3">Weiter</button>
      </div>
      <div class="row" id="pendingStep3" style="display:none">
        <div>
          <label>Betrag (‚Ç¨)</label>
          <input type="number" id="pendingAmount" step="0.01" />
          <p class="muted">Betrag wird durch Template gesetzt, kann aber manuell angepasst werden.</p>
        </div>
        <div class="muted" id="pendingSummary"></div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-yellow" id="pendingConfirm">Best√§tigen</button>
          <button class="btn btn-blue" id="pendingCancel">Abbrechen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Mitglied bearbeiten -->
  <div id="editModal" class="modal-overlay">
    <div class="modal">
      <h3>Mitglied bearbeiten</h3>
      <div class="row">
        <div>
          <label>Neuer Name</label>
          <input type="text" id="editName" placeholder="Neuer Mitgliedsname" />
        </div>
        <div>
          <label>Neue ID</label>
          <input type="text" id="editId" placeholder="z. B. M001" />
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-blue" id="btnEditSave">Speichern</button>
        <button class="btn btn-danger" id="btnEditCancel">Abbrechen</button>
      </div>
      <p class="muted" id="editHint"></p>
    </div>
  </div>

  <footer>Made by Alvaro SolanoHebel | 20367</footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    /* -------------------- Firebase Setup -------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBgPA5LV1ILz5MmyzUezVumMgOuWoxfNxo",
      authDomain: "msauszahlung.firebaseapp.com",
      projectId: "msauszahlung",
      storageBucket: "msauszahlung.appspot.com",
      messagingSenderId: "1033439801595",
      appId: "1:1033439801595:web:4251badc1447ed8079805e",
      measurementId: "G-FWXF3GM505"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /* -------------------- UI Refs -------------------- */
    const authCard = document.getElementById("authCard");
    const appEl = document.getElementById("app");
    const overviewEl = document.getElementById("overview");
    const authState = document.getElementById("authState");
    const email = document.getElementById("email");
    const password = document.getElementById("password");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");

    const tbody = document.getElementById("tbody");
    const statMitglieder = document.getElementById("statMitglieder");
    const statSaldo = document.getElementById("statSaldo");

    // Add Member Refs
    const addName = document.getElementById("addName");
    const addId = document.getElementById("addId");
    const addWarn = document.getElementById("addWarn");
    const addCName = document.getElementById("addCName");
    const addCId = document.getElementById("addCId");

    // Payout Refs
    const payoutMember = document.getElementById("payoutMember");
    const payoutEvent = document.getElementById("payoutEvent");
    const payoutAmount = document.getElementById("payoutAmount");
    const payoutSummary = document.getElementById("payoutSummary");

    // Pending Refs
    const pendingMember = document.getElementById("pendingMember");
    const pendingEvent = document.getElementById("pendingEvent");
    const pendingAmount = document.getElementById("pendingAmount");
    const pendingSummary = document.getElementById("pendingSummary");

    // Edit Refs
    const editModal = document.getElementById("editModal");
    const editNameInput = document.getElementById("editName");
    const editIdInput = document.getElementById("editId");
    const btnEditSave = document.getElementById("btnEditSave");
    const btnEditCancel = document.getElementById("btnEditCancel");
    const editHint = document.getElementById("editHint");

    let unsubMembers = null;
    let currentMemberName = null;

    function setLoggedUI(on){
      authCard.style.display = on ? "none" : "";
      appEl.style.display = on ? "" : "none";
      overviewEl.style.display = on ? "" : "none";
      btnLogin.style.display = on ? "none" : "inline-block";
      btnLogout.style.display = on ? "inline-block" : "none";
      authState.textContent = on ? "Angemeldet" : "Abgemeldet";
    }

    /* -------------------- Auth -------------------- */
    btnLogin.onclick = async () => {
      authState.textContent = "Anmeldung l√§uft‚Ä¶";
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
        await auth.signInWithEmailAndPassword(email.value, password.value);
        authState.textContent = "Angemeldet";
      }catch(e){ authState.textContent = e?.message || "Login fehlgeschlagen"; }
    };
    btnLogout.onclick = async () => { await auth.signOut(); };

    auth.onAuthStateChanged(user => {
      const loggedIn = !!user;
      setLoggedUI(loggedIn);
      if (unsubMembers){ unsubMembers(); unsubMembers = null; }
      if (loggedIn){
        unsubMembers = db.collection("members").orderBy("name").onSnapshot(snap=>{
          tbody.innerHTML = ""; let total=0, count=0;
          snap.forEach(doc=>{
            const m = doc.data();
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${escapeHTML(m.name)}</td>
              <td>${escapeHTML(m.id || "")}</td>
              <td class="right">${toLocale(m.balance || 0)}</td>
              <td class="right">
                <button class="xbtn" title="Bearbeiten" onclick="editMember('${escapeAttr(m.name)}')">‚úé</button>
                <button class="xbtn" title="L√∂schen" onclick="deleteMember('${escapeAttr(m.name)}')">‚úï</button>
              </td>`;
            tbody.appendChild(tr);
            total += (m.balance || 0); count++;
          });
          statMitglieder.textContent = String(count);
          statSaldo.textContent = toLocale(round2(total));
        });
      }
    });

    /* -------------------- Event-Templates -------------------- */
    const eventTemplates = {
      "40er Kill / Win": 30000, "40er Kill / Lose": 15000, "50er Win": 35000,
      "Bizwar Kill Win": 20000, "Bizwar Kill Lose": 10000, "Bizwar Teilnahme": 10000,
      "Waffenfab. Kill Win": 20000, "Waffenfab. Kills Lose": 10000, "Waffenfab. Win": 20000,
      "Gie√üerei Kills Win": 20000, "Gie√üerei Kills Lose": 10000,
      "Bank (Gewinn abh√§ngig)": 20000, "Hafen Drop": 25000, "EKZ/Mall Win": 50000,
      "RP Fabrik Win": 300000, "RP Fabrik Teilnahme": 0, "Cayo": 50000,
      "Sanktion": 0, "Komplett Auszahlung": -1
    };

    function fillEvents(selectEl, amountEl){
      selectEl.innerHTML = "";
      const entries = Object.entries(eventTemplates).sort((a,b)=> a[0].localeCompare(b[0], "de"));
      for (const [label, value] of entries){
        const opt = document.createElement("option");
        opt.value = label;
        opt.textContent = `${label} (${formatEUR(value)})`;
        selectEl.appendChild(opt);
      }
      selectEl.onchange = () => {
        const ev = selectEl.value;
        if (ev && eventTemplates[ev] != null) amountEl.value = eventTemplates[ev];
        if (selectEl === payoutEvent) updatePayoutSummary();
        if (selectEl === pendingEvent) updatePendingSummary();
      };
      if (selectEl.options.length){
        selectEl.selectedIndex = 0;
        amountEl.value = eventTemplates[selectEl.value] ?? "";
      }
    }

    function fillMembers(selectEl){
      selectEl.innerHTML = "";
      db.collection("members").orderBy("name").get().then(snap=>{
        snap.forEach(doc=>{
          const m = doc.data();
          const opt = document.createElement("option");
          opt.value = m.name;
          opt.textContent = m.name;
          selectEl.appendChild(opt);
        });
      });
    }

    /* -------------------- Helpers -------------------- */
    function openModal(id){ document.getElementById(id).classList.add("active"); }
    function closeModal(id){ document.getElementById(id).classList.remove("active"); }

    function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }
    function toLocale(n){ return (n || 0).toLocaleString("de-DE"); }
    function formatEUR(n){ try { return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:0}).format(n); } catch(e){ return n.toString(); } }
    function escapeHTML(str){ return String(str).replace(/[&<>'"]/g, s => ({ "&":"&amp;","<":"&lt;","&gt;":"&gt;","'":"&#39;","\"":"&quot;" }[s])); }
    function escapeAttr(str){ return String(str).replace(/["'\\`]/g, "_"); }

    async function ensureMember(name, idMaybe){
      const ref = db.collection("members").doc(name);
      const snap = await ref.get();
      if (!snap.exists){
        await ref.set({ name, id: idMaybe || "", balance: 0 });
      } else if (idMaybe && !(snap.data().id)){
        await ref.update({ id: idMaybe });
      }
      return ref;
    }

    async function addTransaction(memberRef, memberName, memberId, type, event, amount){
      await db.runTransaction(async (tx) => {
        const snap = await tx.get(memberRef);
        if (!snap.exists) throw new Error("Mitglied nicht gefunden");
        let balance = snap.data().balance || 0;
        balance = type === "einzahlung" ? balance + amount : balance - amount;

        tx.update(memberRef, { balance });

        const tRef = db.collection("transactions").doc();
        tx.set(tRef, {
          ts: new Date().toISOString(),
          member: memberName,
          memberId: memberId || snap.data().id || "",
          type, event, amount, newBalance: balance
        });
      });
    }

    /* -------------------- Workflows -------------------- */

    // Mitglied hinzuf√ºgen
    document.getElementById("btnAddMember").onclick = () => {
      addName.value = ""; addId.value = ""; addWarn.style.display = "none";
      document.getElementById("addStep1").style.display = "grid";
      document.getElementById("addStep2").style.display = "none";
      openModal("addMemberModal");
    };
    document.getElementById("addToStep2").onclick = () => {
      const n = (addName.value || "").trim();
      if (!n) return;
      addWarn.style.display = "none";
      addCName.textContent = escapeHTML(n);
      addCId.textContent = escapeHTML(addId.value || "‚Äî");
      document.getElementById("addStep1").style.display = "none";
      document.getElementById("addStep2").style.display = "grid";
    };
    document.getElementById("addCancel").onclick = () => closeModal("addMemberModal");
    document.getElementById("addId").addEventListener("input", ()=>{ addCId.textContent = escapeHTML(addId.value || "‚Äî"); });
    document.getElementById("addConfirm").onclick = async () => {
      const name = (addName.value || "").trim();
      const id = (addId.value || "").trim();
      if (!name) return;
      const ref = db.collection("members").doc(name);
      const snap = await ref.get();
      if (snap.exists){ addWarn.style.display = "block"; return; }
      await ref.set({ name, id, balance: 0 });
      closeModal("addMemberModal");
    };

    // Auszahlung
    document.getElementById("btnPayout").onclick = () => {
      document.getElementById("payoutStep1").style.display = "grid";
      document.getElementById("payoutStep2").style.display = "none";
      document.getElementById("payoutStep3").style.display = "none";
      payoutSummary.textContent = "";
      fillMembers(payoutMember);
      fillEvents(payoutEvent, payoutAmount);
      openModal("payoutModal");
    };
    document.getElementById("payoutToStep2").onclick = () => {
      if (!payoutMember.value) return;
      document.getElementById("payoutStep1").style.display = "none";
      document.getElementById("payoutStep2").style.display = "grid";
    };
    document.getElementById("payoutToStep3").onclick = async () => {
      if (!payoutEvent.value) return;
      document.getElementById("payoutStep2").style.display = "none";
      document.getElementById("payoutStep3").style.display = "grid";
      updatePayoutSummary();
    };
    document.getElementById("payoutAmount").addEventListener("input", updatePayoutSummary);
    document.getElementById("payoutCancel").onclick = () => closeModal("payoutModal");
    document.getElementById("payoutConfirm").onclick = async () => {
      const name = payoutMember.value;
      const ev = payoutEvent.value;
      const amount = parseFloat(payoutAmount.value);
      if (!name || !ev || isNaN(amount)) return;
      const ref = await ensureMember(name, null);
      await addTransaction(ref, name, null, "auszahlung", ev, amount);
      closeModal("payoutModal");
    };
    async function updatePayoutSummary(){
      const name = payoutMember.value;
      const ev = payoutEvent.value;
      const amount = parseFloat(payoutAmount.value);
      if (!name || !ev || isNaN(amount)) { payoutSummary.textContent = ""; return; }
      const snap = await db.collection("members").doc(name).get();
      const id = snap.exists ? (snap.data().id || "‚Äî") : "‚Äî";
      payoutSummary.innerHTML = `M√∂chtest du <b>${escapeHTML(name)} | ${escapeHTML(id)}</b> f√ºr <b>${escapeHTML(ev)}</b> mit dem Betrag <b>${toLocale(amount)}</b> ‚Ç¨ auszahlen?`;
    }

    // Offene Auszahlung (Geld hinzuf√ºgen)
    document.getElementById("btnPending").onclick = () => {
      document.getElementById("pendingStep1").style.display = "grid";
      document.getElementById("pendingStep2").style.display = "none";
      document.getElementById("pendingStep3").style.display = "none";
      pendingSummary.textContent = "";
      fillMembers(pendingMember);
      fillEvents(pendingEvent, pendingAmount);
      openModal("pendingModal");
    };
    document.getElementById("pendingToStep2").onclick = () => {
      if (!pendingMember.value) return;
      document.getElementById("pendingStep1").style.display = "none";
      document.getElementById("pendingStep2").style.display = "grid";
    };
    document.getElementById("pendingToStep3").onclick = async () => {
      if (!pendingEvent.value) return;
      document.getElementById("pendingStep2").style.display = "none";
      document.getElementById("pendingStep3").style.display = "grid";
      updatePendingSummary();
    };
    document.getElementById("pendingAmount").addEventListener("input", updatePendingSummary);
    document.getElementById("pendingCancel").onclick = () => closeModal("pendingModal");
    document.getElementById("pendingConfirm").onclick = async () => {
      const name = pendingMember.value;
      const ev = pendingEvent.value;
      const amount = parseFloat(pendingAmount.value);
      if (!name || !ev || isNaN(amount)) return;
      const ref = await ensureMember(name, null);
      await addTransaction(ref, name, null, "einzahlung", ev, amount);
      closeModal("pendingModal");
    };
    async function updatePendingSummary(){
      const name = pendingMember.value;
      const ev = pendingEvent.value;
      const amount = parseFloat(pendingAmount.value);
      if (!name || !ev || isNaN(amount)) { pendingSummary.textContent = ""; return; }
      const snap = await db.collection("members").doc(name).get();
      const id = snap.exists ? (snap.data().id || "‚Äî") : "‚Äî";
      pendingSummary.innerHTML = `M√∂chtest du <b>${escapeHTML(name)} | ${escapeHTML(id)}</b> f√ºr <b>${escapeHTML(ev)}</b> den Betrag <b>${toLocale(amount)}</b> ‚Ç¨ <u>hinzuf√ºgen</u>?`;
    }

    /* -------------------- Mitglied bearbeiten/l√∂schen -------------------- */
    window.editMember = async function(name){
      try{
        const ref = db.collection("members").doc(name);
        const snap = await ref.get();
        if (!snap.exists){ alert("Mitglied nicht gefunden."); return; }
        const data = snap.data();
        currentMemberName = data.name;
        editNameInput.value = data.name;
        editIdInput.value = data.id || "";
        editHint.textContent = "Hinweis: Eine Namens√§nderung legt ein neues Dokument an und √ºbernimmt den Kontostand.";
        openModal("editModal");
      }catch(e){ alert("Fehler beim Laden: " + (e?.message || e)); }
    };
    window.deleteMember = async function(name){
      const ok = confirm(`Mitglied "${name}" wirklich entfernen? Transaktionen bleiben erhalten.`);
      if (!ok) return;
      try{ await db.collection("members").doc(name).delete(); }
      catch(e){ alert("L√∂schen fehlgeschlagen: " + (e?.message || e)); }
    };
    btnEditCancel.onclick = () => closeModal("editModal");
    window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") document.querySelectorAll(".modal-overlay.active").forEach(m=>m.classList.remove("active")); });
    document.querySelectorAll(".modal-overlay").forEach(ov=>ov.addEventListener("click",(e)=>{ if(e.target===ov) ov.classList.remove("active"); }));

    btnEditSave.onclick = async () => {
      if (!currentMemberName) return;
      btnEditSave.disabled = true; btnEditCancel.disabled = true;
      editHint.textContent = "Speichern‚Ä¶";
      try{
        const newName = (editNameInput.value || "").trim();
        const newId = (editIdInput.value || "").trim();
        if (!newName){ alert("Name darf nicht leer sein."); return; }

        const oldRef = db.collection("members").doc(currentMemberName);
        const oldSnap = await oldRef.get();
        if (!oldSnap.exists){ alert("Altes Mitglied nicht gefunden."); return; }
        const oldData = oldSnap.data();

        if (newName !== currentMemberName){
          const newRef = db.collection("members").doc(newName);
          if ((await newRef.get()).exists){ alert("Ein Mitglied mit diesem neuen Namen existiert bereits."); return; }
          await newRef.set({ name: newName, id: newId, balance: oldData.balance || 0 });
          await oldRef.delete();
        } else {
          await oldRef.update({ id: newId });
        }
        closeModal("editModal");
      }catch(e){
        alert("Bearbeiten fehlgeschlagen: " + (e?.message || e));
      }finally{
        btnEditSave.disabled = false; btnEditCancel.disabled = false;
        editHint.textContent = "";
        currentMemberName = null;
      }
    };

    /* -------------------- Hintergrund: Partikel-Netz -------------------- */
    (function(){
      const canvas = document.getElementById('netCanvas');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      let particles = [];
      let w = 0, h = 0;

      function resize(){
        w = canvas.clientWidth; h = canvas.clientHeight;
        if(!w||!h) return;
        canvas.width = Math.floor(w * DPR); canvas.height = Math.floor(h * DPR);
        ctx.setTransform(DPR,0,0,DPR,0,0);

        const targetCount = Math.round((w*h)/9000);
        const max = window.matchMedia('(max-width: 900px)').matches ? 80 : 140;
        const min = 50;
        const count = Math.max(min, Math.min(max, targetCount));

        if (particles.length > count) particles.length = count;
        while (particles.length < count){
          particles.push({ x: Math.random()*w, y: Math.random()*h, vx:(Math.random()*2-1)*0.25, vy:(Math.random()*2-1)*0.25, r: Math.random()*1.2+0.6 });
        }
      }

      const MAX_D = 160, DOT_A = 0.35, LINK_A = 0.14;

      function step(){
        ctx.clearRect(0,0,w,h);
        ctx.beginPath();
        for (const p of particles){
          p.x += p.vx; p.y += p.vy;
          if (p.x < -20 || p.x > w+20) p.vx *= -1;
          if (p.y < -20 || p.y > h+20) p.vy *= -1;
          ctx.moveTo(p.x + p.r, p.y);
          ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        }
        ctx.fillStyle = `rgba(255,255,255,${DOT_A})`; ctx.fill();

        for (let i=0;i<particles.length;i++){
          for (let j=i+1;j<particles.length;j++){
            const a=particles[i], b=particles[j];
            const dx=a.x-b.x, dy=a.y-b.y;
            const d2=dx*dx+dy*dy;
            if(d2<MAX_D*MAX_D){
              const alpha=(1-Math.sqrt(d2)/MAX_D)*LINK_A;
              ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y);
              ctx.strokeStyle=`rgba(255,255,255,${alpha})`; ctx.lineWidth=1; ctx.stroke();
            }
          }
        }
        requestAnimationFrame(step);
      }

      window.addEventListener('resize', resize, {passive:true});
      resize(); requestAnimationFrame(step);
    })();
  </script>
</body>
</html>
