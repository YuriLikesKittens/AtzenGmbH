<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plantage-Log</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;800&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f1a;
      --bg2:#111828;
      --text:#f3f4f6;
      --muted:#cbd5e1;
      --accent:#7c3aed;
      --accent2:#06b6d4;
      --radius:20px;
      --stroke: rgba(255,255,255,.16);
      --panel: rgba(255,255,255,.08);
      --shadow: 0 18px 42px rgba(124,58,237,.22), inset 0 0 0 1px var(--stroke);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(124,58,237,.16), transparent 40%),
        radial-gradient(800px 600px at 90% 20%, rgba(6,182,212,.15), transparent 45%),
        radial-gradient(1000px 700px at 80% 90%, rgba(34,197,94,.12), transparent 45%),
        linear-gradient(160deg,var(--bg) 0%, var(--bg2) 100%);
      overflow-x:hidden;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      padding:24px 16px 40px;
    }

    /* Hintergrund */
    .net-bg{position:fixed; inset:0; pointer-events:none; z-index:0}
    .net-bg canvas{width:100%; height:100%; display:block}
    .grid-bg{position:fixed; inset:0; pointer-events:none; opacity:.35; mix-blend-mode:screen;
      background:
        linear-gradient(transparent 0 49%, rgba(255,255,255,.10) 49% 51%, transparent 51% 100%),
        linear-gradient(90deg, transparent 0 49%, rgba(255,255,255,.10) 49% 51%, transparent 51% 100%);
      background-size: 40px 40px, 40px 40px;
      transform: perspective(800px) rotateX(55deg) scale(1.2);
      transform-origin: top center;
      animation: floatGrid 18s linear infinite;
      z-index:0;
    }
    @keyframes floatGrid { 0% { background-position:0 0, 0 0 } 100% { background-position:0 40px, 40px 0 } }

    .wrap{max-width:1100px;margin:0 auto;position:relative;z-index:1}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px}
    h1{margin:0;font-size:clamp(22px,4vw,32px);font-weight:800;font-family: Orbitron, Inter}

    a.btn, button.btn{
      display:inline-block;
      padding:10px 14px;
      border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#fff;
      text-decoration:none;
      font-weight:700;
      border:0;
      cursor:pointer;
      box-shadow:0 10px 26px rgba(6,182,212,.34), inset 0 0 0 1px rgba(255,255,255,.05);
      transition: transform .2s ease, filter .2s ease, box-shadow .2s ease;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.05);box-shadow:0 14px 36px rgba(124,58,237,.30)}
    .btnrow{display:flex;gap:8px;flex-wrap:wrap}

    .card{
      position:relative; border-radius:var(--radius); padding:20px;
      background:
        radial-gradient(120% 150% at 0% 0%, rgba(255,255,255,.07), rgba(255,255,255,.03)),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      backdrop-filter: blur(8px) saturate(1.2);
      box-shadow:0 14px 36px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
      margin-bottom:18px;
    }
    h2{margin:0 0 12px;font-size:18px}
    label{font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)}
    input{
      width:100%;padding:12px 14px;border-radius:12px;
      border:1px solid var(--stroke);background:#0b1020;color:var(--text);
      outline:none;transition:.2s
    }
    input:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(124,58,237,.2)}

    .plantage-img{width:100%;max-height:260px;object-fit:cover;border-radius:12px;margin-bottom:8px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .list{display:grid;grid-template-columns:1fr;gap:12px}
    .item{position:relative;border:1px solid var(--stroke);border-radius:14px;padding:14px;background:rgba(255,255,255,.03)}
    .logHeader{font-size:15px;font-weight:800;margin:0 0 6px;color:#e5e7eb}
    .logBody{font-size:14px}
    .meta{color:var(--muted);font-size:12px;margin-top:6px}

    /* Admin-sichtbare Elemente */
    .admin-only{display:none}
    body.admin .admin-only{display:block}
    .delbtn{
      position:absolute;top:8px;right:8px;
      width:32px;height:32px;border-radius:999px;
      background:#0b1020;border:1px solid var(--stroke);color:#fca5a5;
      font-weight:800;cursor:pointer;line-height:30px;text-align:center;
    }
    .delbtn:hover{background:#1f2937;color:#fff}

    /* --- Popup (Overlay) --- */
    #adminPopup{
      display:none; position:fixed; inset:0; z-index:999;
      background:rgba(0,0,0,.6); backdrop-filter:blur(4px);
      align-items:center; justify-content:center;
    }
    .adminPopup-card{
      width:90%; max-width:420px; border-radius:16px;
      background:#111827; border:1px solid var(--stroke);
      box-shadow:0 18px 42px rgba(0,0,0,.5);
      padding:22px;
    }
  </style>
</head>
<body>
  <!-- EINMALIGER Hintergrund -->
  <div class="net-bg" aria-hidden="true"><canvas id="netCanvas"></canvas></div>
  <div class="grid-bg" aria-hidden="true"></div>

  <div class="wrap">
    <div class="topbar">
      <h1>Plantage-Log</h1>
      <div class="btnrow">
        <a class="btn" href="index.html">Zur Übersicht</a>
        <button class="btn" id="btnAdminLogin">Admin-Login</button>
      </div>
    </div>

    <!-- Popup-Login -->
    <div id="adminPopup">
      <div class="adminPopup-card">
        <h2 style="margin:0 0 14px;font-size:18px">Admin Login</h2>
        <div class="authrow" style="margin-bottom:12px">
          <div>
            <label>E-Mail</label>
            <input type="email" id="email" placeholder="admin@beispiel.de" />
          </div>
          <div>
            <label>Passwort</label>
            <input type="password" id="password" placeholder="********" />
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnLogin">Anmelden</button>
          <button class="btn" id="btnLogout" style="display:none">Abmelden</button>
          <button class="btn" id="btnClosePopup" style="background:#6b7280">Schließen</button>
        </div>
        <p class="meta" id="authState" style="margin-top:8px"></p>
      </div>
    </div>

    <!-- Übersicht -->
    <div class="card">
      <h2>Übersicht</h2>
      <img src="https://i.imgur.com/4x2R4SP.png" alt="Plantage" class="plantage-img">
      <p><b>Plantage Nr.:</b> <span id="plantageNummer">62</span></p>
    </div>

    <!-- Eingabe -->
    <div class="card">
      <h2>Neuen Eintrag hinzufügen</h2>
      <div class="grid" style="margin-bottom:12px">
        <div>
          <label>Name</label>
          <input type="text" id="name" placeholder="Name eingeben" />
        </div>
        <div>
          <label>ID</label>
          <input type="text" id="mitgliedId" placeholder="z. B. M001" />
        </div>
      </div>
      <div>
        <label>Proof-URL (Imgur)</label>
        <input type="url" id="proofUrl" placeholder="Hier Imgur Link einfügen" />
        <a class="linkbtn" href="https://imgur.com/upload" target="_blank" rel="noopener">Bild bei Imgur hochladen ↗</a>
      </div>
      <div style="margin-top:12px">
        <button class="btn" id="btnSave">Eintragen</button>
        <p class="public-note"></p>
        <p class="meta" id="status"></p>
      </div>
    </div>

    <!-- Logs -->
    <div class="card">
      <h2>Logs</h2>
      <div id="list" class="list"></div>
    </div>
  </div>

  <footer style="
    margin-top:24px;text-align:center;font-size:13px;padding:10px;font-weight:600;
    background: linear-gradient(90deg, rgb(255,0,0), rgb(0,255,0), rgb(0,0,255));
    -webkit-background-clip: text;-webkit-text-fill-color: transparent;background-clip: text;color: transparent;
    animation: rgbMove 6s linear infinite;background-size: 300% 100%;
  ">
    Made by Alvaro SolanoHebel | 20367
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    /* === Firebase === */
    const firebaseConfig = {
      apiKey: "AIzaSyBgPA5LV1ILz5MmyzUezVumMgOuWoxfNxo",
      authDomain: "msauszahlung.firebaseapp.com",
      projectId: "msauszahlung",
      storageBucket: "msauszahlung.appspot.com",
      messagingSenderId: "1033439801595",
      appId: "1:1033439801595:web:4251badc1447ed8079805e",
      measurementId: "G-FWXF3GM505"
    };
    try { firebase.initializeApp(firebaseConfig); }
    catch(e){ if(!/already exists/i.test(String(e))) throw e; }
    const auth = firebase.auth();
    const db   = firebase.firestore();

    /* === Discord Webhook === */
    const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1412053136692220054/fCZClu9u7auz5jDvb9qvReSv44lrZO__8KWw0ZHwKZs0L83smUdJdgVmNIwIew2I2pwE";

    /* === UI Refs === */
    const nameInput   = document.getElementById('name');
    const idInput     = document.getElementById('mitgliedId');
    const proofUrlInput = document.getElementById('proofUrl');
    const btnSave     = document.getElementById('btnSave');
    const status      = document.getElementById('status');
    const list        = document.getElementById('list');

    // Popup UI
    const btnAdminLogin = document.getElementById('btnAdminLogin');
    const adminPopup    = document.getElementById('adminPopup');
    const btnClosePopup = document.getElementById('btnClosePopup');
    const email         = document.getElementById('email');
    const password      = document.getElementById('password');
    const btnLogin      = document.getElementById('btnLogin');
    const btnLogout     = document.getElementById('btnLogout');
    const authState     = document.getElementById('authState');

    btnAdminLogin.addEventListener('click', ()=>{ adminPopup.style.display = 'flex'; });
    btnClosePopup.addEventListener('click', ()=>{ adminPopup.style.display = 'none'; });
    adminPopup.addEventListener('click', (e)=>{ if(e.target === adminPopup) adminPopup.style.display='none'; });

    function setAdminUI(on){
      document.body.classList.toggle('admin', !!on);
      if(btnLogin)  btnLogin.style.display  = on ? 'none' : 'inline-block';
      if(btnLogout) btnLogout.style.display = on ? 'inline-block' : 'none';
      if(authState) authState.textContent   = on ? 'Angemeldet' : 'Abgemeldet';
    }
    btnLogin?.addEventListener('click', async () => {
      authState.textContent = 'Anmeldung läuft…';
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
        await auth.signInWithEmailAndPassword(email.value, password.value);
        setAdminUI(true);
      }catch(e){
        authState.textContent = e?.message || 'Login fehlgeschlagen';
      }
    });
    btnLogout?.addEventListener('click', async () => { await auth.signOut(); });
    auth.onAuthStateChanged(user => setAdminUI(!!user));

    /* === Speichern + Discord senden === */
    btnSave.onclick = async () => {
      status.textContent = "Speichere…";
      try {
        const name = (nameInput.value||"").trim();
        const id   = (idInput.value||"").trim();
        const proofUrl = (proofUrlInput.value||"").trim();

        if(!name || !id){
          status.textContent = "Bitte Name und ID ausfühlen.";
          return;
        }

        const payload = { name, id, proofUrl, ts: new Date().toISOString(), serverTs: firebase.firestore.FieldValue.serverTimestamp() };
        await db.collection('plantageLogs').add(payload);

        try { await sendDiscordPlantage(payload); } catch(e){ console.warn("Discord Fehler:", e); }

        nameInput.value=""; idInput.value=""; proofUrlInput.value="";
        status.textContent="Gespeichert & an Discord gesendet.";
        setTimeout(()=>status.textContent="",2000);

      } catch(e){
        console.error(e);
        status.textContent = "Fehler: " + (e.message || e);
      }
    };

    /* === Discord: Plantage-Embed === */
    async function sendDiscordPlantage({name, id, proofUrl, ts}){
      const isImg = isImageUrl(proofUrl||"");
      const embed = {
        title: "🌱 Neuer Plantage-Log",
        color: 0x06b6d4,
        timestamp: new Date(ts || Date.now()).toISOString(),
        fields: [
          { name: "Name", value: name || "—", inline: true },
          { name: "ID",   value: id   || "—", inline: true },
          ...(proofUrl ? [{ name: "Proof", value: proofUrl, inline: false }] : [])
        ],
        thumbnail: isImg ? { url: proofUrl } : undefined,
        footer: { text: "MS Auszahlungen · Plantage-Log" }
      };
      const body = { username: "MS-Plantage System", embeds: [embed] };

      let ok = false;
      try{
        const r = await fetch(DISCORD_WEBHOOK, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        ok = r.ok || r.status === 204;
      }catch{}
      if(!ok){
        try{
          await fetch(DISCORD_WEBHOOK, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
        }catch{}
      }
    }

    function isImageUrl(u){ try{ return /\.(png|jpe?g|webp|gif)$/i.test(new URL(u).pathname); }catch{return false;} }

    /* === Live-List (mit Admin-Löschen) === */
    db.collection('plantageLogs').orderBy('serverTs','desc').limit(100).onSnapshot(snap=>{
      list.innerHTML = "";
      snap.forEach(doc=>{
        const d = doc.data();
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <div class="logHeader">${formatDate(d.serverTs?.toDate ? d.serverTs.toDate() : d.ts)}</div>
          <div class="logBody">
            <b>${escapeHTML(d.name||"")}</b> (${escapeHTML(d.id||"")})<br>
            ${d.proofUrl ? `<a href="${escapeAttr(d.proofUrl)}" target="_blank" rel="noopener">Proof ansehen</a>` : `<i>Kein Proof</i>`}
          </div>
          <button class="delbtn admin-only" title="Diesen Log löschen">✕</button>
        `;
        // Löschen nur, wenn Admin eingeloggt
        const delBtn = el.querySelector('.delbtn');
        delBtn.addEventListener('click', async () => {
          if (!auth.currentUser) { alert('Nur als Admin möglich.'); return; }
          const ok = confirm('Diesen Plantage-Log wirklich löschen?');
          if (!ok) return;
          try {
            await db.collection('plantageLogs').doc(doc.id).delete();
          } catch (e) {
            alert('Löschen fehlgeschlagen: ' + (e?.message || e));
          }
        });
        list.appendChild(el);
      });
    });

    /* === Hintergrund-Particles === */
    (function(){
      const canvas = document.getElementById('netCanvas');
      const ctx = canvas.getContext('2d');
      let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      let particles = [];
      let w = 0, h = 0;

      function resize(){
        w = canvas.clientWidth;
        h = canvas.clientHeight;
        canvas.width = Math.floor(w * DPR);
        canvas.height = Math.floor(h * DPR);
        ctx.setTransform(DPR,0,0,DPR,0,0);

        const targetCount = Math.round((w*h)/9000);
        const max = window.matchMedia('(max-width: 900px)').matches ? 80 : 140;
        const min = 50;
        const count = Math.max(min, Math.min(max, targetCount));

        if (particles.length > count) particles.length = count;
        while (particles.length < count){ particles.push(makeParticle()); }
      }

      function makeParticle(){
        return {
          x: Math.random()*w,
          y: Math.random()*h,
          vx: (Math.random()*2-1)*0.25,
          vy: (Math.random()*2-1)*0.25,
          r: Math.random()*1.2 + 0.6
        };
      }

      let MAX_D = 160, DOT_A = 0.85, LINK_A = 0.22;

      function step(){
        ctx.clearRect(0,0,w,h);

        ctx.beginPath();
        particles.forEach(p=>{
          p.x += p.vx; p.y += p.vy;
          if (p.x < -20 || p.x > w+20) p.vx *= -1;
          if (p.y < -20 || p.y > h+20) p.vy *= -1;
          ctx.moveTo(p.x + p.r, p.y);
          ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        });
        ctx.fillStyle = `rgba(255,255,255,${DOT_A})`;
        ctx.fill();

        for (let i=0;i<particles.length;i++){
          for (let j=i+1;j<particles.length;j++){
            const a = particles[i], b = particles[j];
            const dx = a.x-b.x, dy = a.y-b.y;
            const d2 = dx*dx + dy*dy;
            if (d2 < MAX_D*MAX_D){
              const alpha = 1 - Math.sqrt(d2)/MAX_D;
              ctx.beginPath();
              ctx.moveTo(a.x, a.y);
              ctx.lineTo(b.x, b.y);
              ctx.strokeStyle = `rgba(255,255,255,${alpha*LINK_A})`;
              ctx.lineWidth = 1;
              ctx.stroke();
            }
          }
        }
        requestAnimationFrame(step);
      }

      window.addEventListener('resize', resize, {passive:true});
      resize();
      requestAnimationFrame(step);
    })();

    /* === Helpers === */
    function formatDate(x){ try{ return (x instanceof Date?x:new Date(x)).toLocaleString('de-DE'); }catch{ return String(x); } }
    function escapeHTML(str){ return String(str).replace(/[&<>'"]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[s])); }
    function escapeAttr(str){ return String(str).replace(/["'\\`]/g, "_"); }
  </script>
</body>
</html>
